---
title: "CPFV_pelagics_CINMS_visualization"
output: github_document
editor_options: 
  chunk_output_type: inline
---
project: 2023 cpfv rec fishing and pelagics re: response to letters as part of MPA review
PI: Jenny Selgrath
Purpose of code: to create graphs (bar and line graphs and heat maps) depicting pelagic CPFV catch in the CDFW fishing blocks within CINMS boundaries.
______________
data input: CPFV_pelagic_species_subset.Rds
** see read.me file in Data and Bin folders for more information about data and code. Code adapted/pulled from existing code provided by Chris Free (UCSB) via email on 10/2/2023
_______________
Graph output:  
_______________
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readr)
library(tidyverse)
library(FishLife)
library(freeR)
library(dplyr)
library(janitor)
library(ggplot2)
library(lubridate)
library(sf)
library(tidyr)
library(viridis)
library(quantmod) 
library(egg)
library(ggspatial)
library(OneR)
library(gganimate)
library(transformr)
library(maps)
library(rnaturalearthdata)
library(rnaturalearth)
library(tidyquant)
path_out="\\\\10.74.13.28/ci-users/Vanessa.Van.Deusen/R_projects/CPFV_pelagics/Data"
path_plot="\\\\10.74.13.28/ci-users/Vanessa.Van.Deusen/R_projects/CPFV_pelagics/Data/graphs/CINMS"
```

# Importing data
```{r cars}
CPFV_pelagics<-readRDS("//10.74.13.28/ci-users/Vanessa.Van.Deusen/R_projects/CPFV_pelagics/Data/CPFV_pelagic_species_subset.Rds")
#MPA_shapefile<-st_read("//10.74.13.28/ci-users/Vanessa.Van.Deusen/R_projects/CPFV_pelagics/Data/MPA_fishingblocks/MPA_footprint_gullisland_sb_commercial_blocks.shp")
CINMS<-st_read("//10.74.13.28/ci-users/Vanessa.Van.Deusen/R_projects/CPFV_pelagics/Data/CINMS_shapefile/CINMS.shp")
CINMS_surrounding_fishing_blocks<-st_read("//10.74.13.28/ci-users/Vanessa.Van.Deusen/R_projects/CPFV_pelagics/Data/MPA_fishingblocks/CINMS_surrounding_fishing_blocks.shp")
CINMS_fishing_blocks<- read_csv("//10.74.13.28/ci-users/Vanessa.Van.Deusen/R_projects/CPFV_pelagics/Data/CINMS_fishingblock_intersect.csv")
gas_adjusted2020<-read_csv("//10.74.13.28/ci-users/Vanessa.Van.Deusen/R_projects/CPFV_pelagics/Data/gas_adjusted2020.csv")
CINMS_state_MPA<-st_read("//10.74.13.28/ci-users/Vanessa.Van.Deusen/R_projects/CPFV_pelagics/Data/MPA_CINMS/MPA_State_CINMS_shapefile/CINMS_State_MPAs.shp")
CINMS_fed_MPA<-st_read("//10.74.13.28/ci-users/Vanessa.Van.Deusen/R_projects/CPFV_pelagics/Data/MPA_CINMS/MPA_Fed_CINMS_shapefile/CINMS_Fed_MPAs.shp")
designation_MHW_ENSO_years<-read_csv("//10.74.13.28/ci-users/Vanessa.Van.Deusen/R_projects/CPFV_pelagics/Data/Geom_vlines_designation_MHW_ENSO.csv")
strong_1_pdo<-read_csv("//10.74.13.28/ci-users/Vanessa.Van.Deusen/R_projects/CPFV_pelagics/Data/strong_1_pdo.csv")
```

#______________
#Pre-processing
##Subsetting by CINMS blocks
```{r}
unique(CINMS_fishing_blocks[,c("BLOCK10_ID")])
CPFV_pelagics_allblocks<- CPFV_pelagics%>% subset(block_id==744|
                                       block_id==745|
                                       block_id==764|
                                       block_id==765|
                                       block_id==766|
                                       block_id==667|
                                       block_id==668|
                                       block_id==670|
                                       block_id==671|
                                       block_id==672|
                                       block_id==683|
                                       block_id==684|
                                       block_id==685|
                                       block_id==686|
                                       block_id==687|
                                       block_id==688|
                                       block_id==689|
                                       block_id==690|
                                       block_id==691|
                                       block_id==706|
                                       block_id==707|
                                       block_id==708|
                                       block_id==709|
                                       block_id==710|
                                       block_id==711|
                                       block_id==712|
                                       block_id==713|
                                       block_id==714|
                                       block_id==729|
                                       block_id==730|
                                       block_id==731)

```
```{r}
CINMS_shpfile_blocks<- CINMS_surrounding_fishing_blocks%>% subset(BLOCK10_ID==744|
                                       BLOCK10_ID==745|
                                       BLOCK10_ID==764|
                                       BLOCK10_ID==765|
                                       BLOCK10_ID==766|
                                       BLOCK10_ID==667|
                                       BLOCK10_ID==668|
                                       BLOCK10_ID==670|
                                       BLOCK10_ID==671|
                                       BLOCK10_ID==672|
                                       BLOCK10_ID==683|
                                       BLOCK10_ID==684|
                                       BLOCK10_ID==685|
                                       BLOCK10_ID==686|
                                       BLOCK10_ID==687|
                                       BLOCK10_ID==688|
                                       BLOCK10_ID==689|
                                       BLOCK10_ID==690|
                                       BLOCK10_ID==691|
                                       BLOCK10_ID==706|
                                       BLOCK10_ID==707|
                                       BLOCK10_ID==708|
                                       BLOCK10_ID==709|
                                       BLOCK10_ID==710|
                                       BLOCK10_ID==711|
                                       BLOCK10_ID==712|
                                       BLOCK10_ID==713|
                                       BLOCK10_ID==714|
                                       BLOCK10_ID==729|
                                       BLOCK10_ID==730|
                                       BLOCK10_ID==731)
```


##Removing billfish, baitfish, opah, and sharks
```{r}
##removing species
CPFV_pelagics_allblocks_rm<-subset(CPFV_pelagics_allblocks, CPFV_pelagics_allblocks$species_type != "Opah"& CPFV_pelagics_allblocks$species_type != "Shark"& CPFV_pelagics_allblocks$species_type != "Baitfish"& CPFV_pelagics_allblocks$species_type != "Billfish"& CPFV_pelagics_allblocks$species_type != "Mackerel")
```


## Agg CPUE_p by type and year
```{r}
CINMS_sum_years_individ<-CPFV_pelagics_allblocks_rm %>%
  group_by(year, species_type)%>%
  summarise(average_cpue_p= mean(CPUE_p), 
            std_cpue_p= sd(CPUE_p, na.rm=F), 
            min_cpue_p= min(CPUE_p), 
            max_cpue_p= max(CPUE_p), 
            n_cpue_p= length(CPUE_p), 
            se_cpue_p= std_cpue_p/sqrt(n_cpue_p))
  ## Nas in dataframe are because you can't calulcate SE or STD from one observation
CINMS_sum_years_individ<-CINMS_sum_years_individ %>% 
    mutate(CPUE_pos_se=average_cpue_p+se_cpue_p, 
           CPUE_neg_se=average_cpue_p-se_cpue_p) 
```

## Agg CPUE_p by year
```{r}
CINMS_years_CPUE<-CPFV_pelagics_allblocks_rm %>%
  group_by(year)%>%
  summarise(average_cpue_p= mean(CPUE_p), 
            std_cpue_p= sd(CPUE_p, na.rm=F), 
            min_cpue_p= min(CPUE_p), 
            max_cpue_p= max(CPUE_p), 
            n_cpue_p= length(CPUE_p), 
            se_cpue_p= std_cpue_p/sqrt(n_cpue_p))
  ## Nas in dataframe are because you can't calulcate SE or STD from one observation
CINMS_years_CPUE<-CINMS_years_CPUE %>% 
    mutate(CPUE_pos_se=average_cpue_p+se_cpue_p, 
           CPUE_neg_se=average_cpue_p-se_cpue_p) 
```

##Agg CPUE_p by year and block 
```{r}
CINMS_year_block_CPUE<-CPFV_pelagics_allblocks_rm %>%
  group_by(year, block_id)%>%
  summarise(average_cpue_p= mean(CPUE_p), 
            total_caught=sum(total_caught))
```
##Agg redact boats by year and block
```{r}
CINMS_year_block_boat<-CPFV_pelagics_allblocks_rm %>%
  group_by(year, block_id)%>%
  summarise(unique_vessels= n_distinct(id_vessel))
CINMS_year_block_boat_redact<- CINMS_year_block_boat %>% subset(unique_vessels<4)
CINMS_year_block_boat_redact<-subset(CINMS_year_block_boat_redact, select= -unique_vessels)
CINMS_year_block_boat_redact$redact<-"Y"
```


#_______________
#Graphing
##Line Graph by Species Group
###PDO color coded--All non-neutral PDO
```{r}
CPFV_pelagics_allblocks_rm$year<-as.numeric(CPFV_pelagics_allblocks_rm$year)
CINMS_sum_years_individ$year<-as.numeric(CINMS_sum_years_individ$year)
#CPFV_pelagics_allblocks_rm$year<-as.numeric(CPFV_pelagics_allblocks_rm$year)
designation_MHW_ENSO_years$year<-as.numeric(designation_MHW_ENSO_years$year)

##Facet wrapped 
ggplot(data= CINMS_sum_years_individ, aes(x=year, y=average_cpue_p))+ 
  geom_line(size=1)+
  #geom_errorbar(aes(ymin=CPUE_neg_se, ymax=CPUE_pos_se))+ ## this gives you SE bars for each year, looks a little messy in terms of visualization 
  geom_smooth(span=.3, color="darkorange", size= 0.75, fill="green", alpha= 0.2)+
  facet_wrap(~species_type)+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust=1))+
  theme(legend.position="top")+
  theme(legend.title=element_blank())+
  ylab("Catch per Unit Effort (fish caught per fisher)")+
  xlab("Years")+
  scale_x_continuous(breaks=seq(1980,2020,5))+
  theme(legend.text=element_text(size=7),
        strip.text.x = element_text(size = 16), 
        axis.title = element_text(size = 16), 
        axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12))+
  geom_vline(data=subset(designation_MHW_ENSO_years, Event=="MHW"|Event== "ENSO"), 
           mapping= aes(xintercept=year), color="gray61",  linetype="dotted", size=1)+
  geom_vline(data=subset(designation_MHW_ENSO_years, Event=="Federal_MPA_Designation"), 
             mapping= aes(xintercept=year),color="gray41", size=1)+
  geom_vline(data=subset(designation_MHW_ENSO_years, Event=="State_MPA_Desingation"), 
             mapping= aes(xintercept=year),color="gray41", size=1)+
   annotate("rect", xmin = 1980, xmax = 1982, ymin = -Inf, ymax = Inf, fill= "red",
        alpha = .1)+
   annotate("rect", xmin = 1983, xmax = 1985, ymin = -Inf, ymax = Inf, fill= "red",
        alpha = .1)+
   annotate("rect", xmin = 1986, xmax = 1988, ymin = -Inf, ymax = Inf, fill= "red",
        alpha = .1)+
   annotate("rect", xmin = 1992, xmax = 1994, ymin = -Inf, ymax = Inf, fill= "red",
        alpha = .1)+
   annotate("rect", xmin = 1995, xmax = 1998, ymin = -Inf, ymax = Inf, fill= "red",
        alpha = .1)+
   annotate("rect", xmin = 2003, xmax = 2004, ymin = -Inf, ymax = Inf, fill= "red",
        alpha = .1)+
  annotate("rect", xmin = 2014, xmax = 2017, ymin = -Inf, ymax = Inf, fill= "red",
        alpha = .1)+
  annotate("rect", xmin = 1982, xmax = 1983, ymin = -Inf, ymax = Inf, fill= "blue",
        alpha = .1)+
  annotate("rect", xmin = 1989, xmax = 1992, ymin = -Inf, ymax = Inf, fill= "blue",
        alpha = .1)+
  annotate("rect", xmin = 1994, xmax = 1995, ymin = -Inf, ymax = Inf, fill= "blue",
        alpha = .1)+
  annotate("rect", xmin = 1998, xmax = 2003, ymin = -Inf, ymax = Inf, fill= "blue",
        alpha = .1)+
  annotate("rect", xmin = 2004, xmax = 2014, ymin = -Inf, ymax = Inf, fill= "blue",
        alpha = .1)+
  annotate("rect", xmin = 2018, xmax = 2020, ymin = -Inf, ymax = Inf, fill= "blue",
        alpha = .1)
ggsave("CINMS_line_pelagic_all_pdo_geom_smooth_auto_0.3span.jpeg", width= 30, height= 20, units= "cm", path = path_plot)
```
###PDO color coded-- +1/-1
```{r}
CPFV_pelagics_allblocks_rm$year<-as.numeric(CPFV_pelagics_allblocks_rm$year)
CINMS_sum_years_individ$year<-as.numeric(CINMS_sum_years_individ$year)
#CPFV_pelagics_allblocks_rm$year<-as.numeric(CPFV_pelagics_allblocks_rm$year)
designation_MHW_ENSO_years$year<-as.numeric(designation_MHW_ENSO_years$year)

##Facet wrapped 
ggplot(data= CINMS_sum_years_individ, aes(x=year, y=average_cpue_p))+ 
  geom_line(size=1)+
  #geom_errorbar(aes(ymin=CPUE_neg_se, ymax=CPUE_pos_se))+ ## this gives you SE bars for each year, looks a little messy in terms of visualization 
  geom_smooth(span=.3, color="darkorange", size= 0.75, fill="green", alpha= 0.2)+
  facet_wrap(~species_type)+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust=1))+
  theme(legend.position="top")+
  theme(legend.title=element_blank())+
  ylab("Catch per Unit Effort (fish caught per fisher)")+
  xlab("Years")+
  scale_x_continuous(breaks=seq(1980,2020,5))+
    theme(legend.text=element_text(size=7),
        strip.text.x = element_text(size = 16), 
        axis.title = element_text(size = 16), 
        axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12))+
  geom_vline(data=subset(designation_MHW_ENSO_years, Event=="MHW"|Event== "ENSO"), 
           mapping= aes(xintercept=year), color="gray61",  linetype="dotted", size=1)+
  geom_vline(data=subset(designation_MHW_ENSO_years, Event=="Federal_MPA_Designation"), 
             mapping= aes(xintercept=year),color="gray41", size=1)+
  geom_vline(data=subset(designation_MHW_ENSO_years, Event=="State_MPA_Desingation"), 
             mapping= aes(xintercept=year),color="gray41", size=1)+
   annotate("rect", xmin = 1983, xmax = 1984, ymin = -Inf, ymax = Inf, fill= "red",
        alpha = .1)+
   annotate("rect", xmin = 1986, xmax = 1988, ymin = -Inf, ymax = Inf, fill= "red",
        alpha = .1)+
   annotate("rect", xmin = 1993, xmax = 1994, ymin = -Inf, ymax = Inf, fill= "red",
        alpha = .1)+
   annotate("rect", xmin = 1997, xmax = 1998, ymin = -Inf, ymax = Inf, fill= "red",
        alpha = .1)+
   annotate("rect", xmin = 1999, xmax = 2002, ymin = -Inf, ymax = Inf, fill= "blue",
        alpha = .1)+
   annotate("rect", xmin = 2008, xmax = 2014, ymin = -Inf, ymax = Inf, fill= "blue",
        alpha = .1)

ggsave("CINMS_line_pelagic_strong_pdo_geom_smooth_auto_0.3span.jpeg", width= 30, height= 20, units= "cm", path = path_plot)
```


##Line Plot- All catch, year, gas, map
Couldn't get the dimesions to graph correctly on the 3 level stacked graph, so making the location graph seperately and then joining outside of R 

###Stacked Line Graph and gas prices 
```{r}
plot1<- ggplot(data=CINMS_years_CPUE, aes(x=year, y=average_cpue_p))+ 
   geom_line(size=1)+
  #geom_errorbar(aes(ymin=CPUE_neg_se, ymax=CPUE_pos_se))+ ## this gives you SE bars for each year, looks a little messy in terms of visualization 
  geom_smooth(span=.3, color="darkorange", size= 1, fill="green", alpha= 0.2)+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust=1))+
  theme(legend.position="top")+
  theme(legend.title=element_blank())+
  ylab("Catch per Unit Effort (fish caught per fisher)")+
  xlab("Years")+
  scale_x_continuous(breaks=seq(1980,2020,5))+
    theme(legend.text=element_text(size=12),
        strip.text.x = element_text(size = 12), 
        axis.title = element_text(size = 12), 
        axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12))+
  geom_vline(data=subset(designation_MHW_ENSO_years, Event=="MHW"|Event== "ENSO"), 
           mapping= aes(xintercept=year), color="gray61",  linetype="dotted", size=1)+
  geom_vline(data=subset(designation_MHW_ENSO_years, Event=="Federal_MPA_Designation"), 
             mapping= aes(xintercept=year),color="gray41", size=1)+
  geom_vline(data=subset(designation_MHW_ENSO_years, Event=="State_MPA_Desingation"), 
             mapping= aes(xintercept=year),color="gray41", size=1)+
   annotate("rect", xmin = 1980, xmax = 1982, ymin = -Inf, ymax = Inf, fill= "red",
        alpha = .1)+
   annotate("rect", xmin = 1983, xmax = 1985, ymin = -Inf, ymax = Inf, fill= "red",
        alpha = .1)+
   annotate("rect", xmin = 1986, xmax = 1988, ymin = -Inf, ymax = Inf, fill= "red",
        alpha = .1)+
   annotate("rect", xmin = 1992, xmax = 1994, ymin = -Inf, ymax = Inf, fill= "red",
        alpha = .1)+
   annotate("rect", xmin = 1995, xmax = 1998, ymin = -Inf, ymax = Inf, fill= "red",
        alpha = .1)+
   annotate("rect", xmin = 2003, xmax = 2004, ymin = -Inf, ymax = Inf, fill= "red",
        alpha = .1)+
  annotate("rect", xmin = 2014, xmax = 2017, ymin = -Inf, ymax = Inf, fill= "red",
        alpha = .1)+
  annotate("rect", xmin = 1982, xmax = 1983, ymin = -Inf, ymax = Inf, fill= "blue",
        alpha = .1)+
  annotate("rect", xmin = 1989, xmax = 1992, ymin = -Inf, ymax = Inf, fill= "blue",
        alpha = .1)+
  annotate("rect", xmin = 1994, xmax = 1995, ymin = -Inf, ymax = Inf, fill= "blue",
        alpha = .1)+
  annotate("rect", xmin = 1998, xmax = 2003, ymin = -Inf, ymax = Inf, fill= "blue",
        alpha = .1)+
  annotate("rect", xmin = 2004, xmax = 2014, ymin = -Inf, ymax = Inf, fill= "blue",
        alpha = .1)+
  annotate("rect", xmin = 2018, xmax = 2020, ymin = -Inf, ymax = Inf, fill= "blue",
        alpha = .1)
plot1

plot2<-ggplot(gas_adjusted2020, aes(Year, adjust_price))+
  geom_line(size=1, color= "darkblue")+
  theme_classic()+
  theme(plot.margin = unit(c(5,5,5,5), 'points'))+
  scale_x_continuous(breaks=seq(1980,2020,1))+
  theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust=1))+
   scale_x_continuous(breaks=seq(1980,2020,10))+
  theme(legend.text=element_text(size=12),
        strip.text.x = element_text(size = 12), 
        axis.title = element_text(size = 12), 
        axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12))+
  theme(strip.text.x = element_text(size = 15))+
  labs(y = paste0("Inflation Adjusted Gas Price ($/gallon)"))+
  xlab("Year")
plot2
plotstacked<-ggarrange(plot1, plot2, nrow=2)
plotstacked
ggsave("CINMS_stacked_gas_all_CPUEp.jpeg", plot= plotstacked, width = 7, height = 8, units="in", path = path_plot)
```
###Location Map
```{r}
plot3<-ggplot()+ 
  geom_sf(data=CINMS_surrounding_fishing_blocks, fill="grey90" )+
  geom_sf(data=CINMS_shpfile_blocks, fill= "blue", alpha=0.25, color="black")+
   geom_sf(data=CINMS_state_MPA, color="black", fill= NA, alpha=0.25)+
   geom_sf(data=CINMS_fed_MPA, color="black", fill=NA, alpha= 0.25)+
   geom_sf(data=CINMS, fill= NA)+
  theme_classic()+
  annotation_scale(location= "bl", pad_y = unit(1, "cm"), pad_x = unit(1.5, "cm"))+
  annotation_north_arrow(location= "tr", which_north= "true", width= unit(1, "cm"), 
                  height= unit(1, "cm"), style= north_arrow_fancy_orienteering(), pad_x = unit(1, "cm"))+
  xlab("Longitude")+
  ylab("Latitude")
plot3
ggsave("CINMS_location_map.jpeg", plot= plot3, width = 5, units="in", path = path_plot)
```


#_______________
#Heat Map 

###Joining shapefile + data
```{r}
##putting in Zeros where there isn't data about fishing blocks
complete_pelagicsCINMS_year_block_rm<-tidyr::complete(ungroup(CINMS_year_block_CPUE), block_id, year, fill=list(average_cpue_p=0, total_caught=0))

##joining shapefile and data
CINMS_shpfile_blocks<-rename(CINMS_shpfile_blocks, "block_id"= "BLOCK10_ID")
CINMS_fishing_blocks_pelagic<-left_join(CINMS_shpfile_blocks, complete_pelagicsCINMS_year_block_rm, by= "block_id", relationship= "many-to-many", na_matches= "never")

##removing NAs
CINMS_fishing_blocks_pelagic<- replace(CINMS_fishing_blocks_pelagic, is.na(CINMS_fishing_blocks_pelagic), 0)

##Calculating Proportional catch (total/max ever)
CINMS_fishing_blocks_pelagic<-CINMS_fishing_blocks_pelagic %>%
  mutate(proportional_catch= total_caught/254143)
```

###Joining shapefile + redaction
```{r}
##joining data and redaction
complete_pelagicsCINMS_year_block_rm$year<-as.character(complete_pelagicsCINMS_year_block_rm$year)
CINMS_year_block_boat_redact$year<-as.character(CINMS_year_block_boat_redact$year)
complete_pelagicsCINMS_year_block_rm_redact<-left_join(complete_pelagicsCINMS_year_block_rm,
                                          CINMS_year_block_boat_redact,  
                                          by= c("block_id","year"), 
                                          relationship= "many-to-many", 
                                          na_matches= "never")
complete_pelagicsCINMS_year_block_rm_redact$year<-as.character(complete_pelagicsCINMS_year_block_rm_redact$year) 
complete_pelagicsCINMS_year_block_rm_redact$redact[is.na(complete_pelagicsCINMS_year_block_rm_redact$redact)]<-"N"
complete_pelagicsCINMS_year_block_rm_redact$total_caught[complete_pelagicsCINMS_year_block_rm_redact$redact=="Y"]<-NA
complete_pelagicsCINMS_year_block_rm_redact$average_cpue_p[complete_pelagicsCINMS_year_block_rm_redact$redact=="Y"]<-NA

##joining shapefile and data
CINMS_redaction_blocks_pelagic<-left_join(CINMS_shpfile_blocks,complete_pelagicsCINMS_year_block_rm_redact,  by= "block_id", relationship= "many-to-many", na_matches= "never")
CINMS_redaction_blocks_pelagic$year<-as.character(CINMS_redaction_blocks_pelagic$year)


```

#Independent scale (geographic range)-- Average CPUE
###Path
```{r}
#path_plot_heatmap<-"\\\\10.74.13.28/ci-users/Vanessa.Van.Deusen/R_projects/CPFV_pelagics/Data/graphs/CINMS/CINMS_heatmaps_by_year/independent_scale/CPUE_fish_per_person_no_redact"
path_plot_heatmap<-"\\\\10.74.13.28/ci-users/Vanessa.Van.Deusen/R_projects/CPFV_pelagics/Data/graphs/CINMS/CINMS_heatmaps_by_year/independent_scale/CPUE_fish_per_person_redact"

```


##"For loop" graphing
iterative loop for printing each block 
###For before MPA designation state= 2004
```{r}
##Subsetting so can add MPAs as designated
#without redaction
#CINMS_fishing_blocks_pelagic_2004<- subset(CINMS_fishing_blocks_pelagic, year<2004)
#with redaction
CINMS_fishing_blocks_pelagic_2004<- subset(CINMS_redaction_blocks_pelagic, year<2004)

##Graphing and saving
for(i in unique(CINMS_fishing_blocks_pelagic_2004$year)){
  x<-ggplot()+
     geom_sf(data=CINMS_shpfile_blocks, fill="white")+
     geom_sf(data= subset(CINMS_fishing_blocks_pelagic_2004, year==i & year<2004), aes(fill=average_cpue_p))+
    #geom_sf(data= CINMS_redaction_blocks_pelagic, fill="grey")+
     scale_fill_gradientn(colours=rev(magma(6)),
                         name="Average catch per unit effort \n(fish caught/fisher)",
                         na.value = "grey", limits= c(0, 8))+
     theme_classic()+
     annotation_scale(location= "bl", width_hint= 0.2, pad_y = unit(1, "cm"), pad_x = unit(0.7, "cm"))+
     annotation_north_arrow(location= "tr", which_north= "true", width= unit(1, "cm"),  
                           height= unit(1, "cm"),style= north_arrow_fancy_orienteering(), 
                           pad_x = unit(0.5, "cm"), pad_y = unit(0.1, "cm"))+
     xlab("Longitude")+
     ylab("Latitude")+
     ggtitle("CINMS CPFV Average Catch Per Unit Effort (fish caught/fisher)", 
              subtitle= paste("Year", i, sep = "-"))

  
  ggsave(x, path= path_plot_heatmap, file=paste0("CINMS_heatmap_individual_average_cpue_fish_per_person", i, ".png") )
}
```



###For after state designation MPAs
```{r}
##Subsetting so can add MPAs as designated
#Without redaction
#CINMS_fishing_blocks_pelagic_2004_2007<- subset(CINMS_fishing_blocks_pelagic, year>2004 & year<2007)
#with redaction
CINMS_fishing_blocks_pelagic_2004_2007<- subset(CINMS_redaction_blocks_pelagic, year>2004 & year<2007)


##Graphing and printing
for(i in unique(CINMS_fishing_blocks_pelagic_2004_2007$year)){
  x<- ggplot()+
      geom_sf(data=CINMS_shpfile_blocks, fill="white")+
      geom_sf(data= subset(CINMS_fishing_blocks_pelagic_2004_2007, year==i & year>2003 & year<2007),
              aes(fill=average_cpue_p))+
      geom_sf(data=CINMS_state_MPA, color="black", fill= "darkblue", alpha=0.25)+
      scale_fill_gradientn(colours=rev(magma(6)),
                         name="Average catch per unit effort \n(fish caught/fisher)",
                         na.value = "grey", limits= c(0, 8))+
      theme_classic()+
      annotation_scale(location= "bl", width_hint= 0.2, pad_y = unit(1, "cm"), pad_x = unit(0.7, "cm"))+
      annotation_north_arrow(location= "tr", which_north= "true", width= unit(1, "cm"),  
                           height= unit(1, "cm"),style= north_arrow_fancy_orienteering(), 
                           pad_x = unit(0.5, "cm"), pad_y = unit(0.1, "cm"))+
      xlab("Longitude")+
      ylab("Latitude")+
      ggtitle("CINMS CPFV Average Catch Per Unit Effort (fish caught/fisher)", 
              subtitle= paste("Year", i, sep = "-"))
  
  ggsave(x, path= path_plot_heatmap, file=paste0("CINMS_heatmap_individual_cpue_fish_per_person", i, ".png") )
}
```

### For after fed designation of MPAs
```{r}
##Subsetting so can add MPAs as designated
#without redaction
##CINMS_fishing_blocks_pelagic_2007<- subset(CINMS_fishing_blocks_pelagic, year>2006)
#with redaction
CINMS_fishing_blocks_pelagic_2007<- subset(CINMS_redaction_blocks_pelagic, year>2006)

##Graphing and printing
for(i in unique(CINMS_fishing_blocks_pelagic_2007$year)){
  x<- ggplot()+
      geom_sf(data=CINMS_shpfile_blocks, fill="white")+
      geom_sf(data= subset(CINMS_fishing_blocks_pelagic_2007, year==i & year>2006), aes(fill=average_cpue_p))+
              geom_sf(data=CINMS_state_MPA, color="black", fill= "darkblue", alpha=0.25)+
              geom_sf(data=CINMS_fed_MPA, color="black", fill="darkgreen", alpha= 0.25)+
      scale_fill_gradientn(colours=rev(magma(6)),
                         name="Average catch per unit effort \n(fish caught/fisher)",
                         na.value = "grey", limits= c(0, 8))+
      theme_classic()+
      annotation_scale(location= "bl", width_hint= 0.2, pad_y = unit(1, "cm"), pad_x = unit(0.7, "cm"))+
      annotation_north_arrow(location= "tr", which_north= "true", width= unit(1, "cm"),  
                           height= unit(1, "cm"),style= north_arrow_fancy_orienteering(), 
                           pad_x = unit(0.5, "cm"), pad_y = unit(0.1, "cm"))+
      xlab("Longitude")+
      ylab("Latitude")+
      ggtitle("CINMS CPFV Average Catch Per Unit Effort (fish caught/fisher)", 
              subtitle= paste("Year", i, sep = "-"))
  
  ggsave(x, path= path_plot_heatmap, file=paste0("CINMS_heatmap_individual_cpue_fish_per_person", i, ".png") )
}
```

#Same scale/CPUE 
###Path
```{r}
path_plot_heatmap<-"\\\\10.74.13.28/ci-users/Vanessa.Van.Deusen/R_projects/CPFV_pelagics/Data/graphs/CINMS/CINMS_heatmaps_by_year/same_scale_geographic"

```

##"For loop" graphing
iterative loop for printing each block 
###For before MPA designation state= 2004
```{r}
##Graphing and saving
for(i in unique(CINMS_fishing_blocks_pelagic_2004$year)){
  x<-ggplot()+
     geom_sf(data=CINMS_shpfile_blocks, fill="white")+
     geom_sf(data= subset(CINMS_fishing_blocks_pelagic_2004, year==i & year<2004), aes(fill=CPUE))+
     scale_fill_gradientn(colours=rev(magma(6)),
                         name="Catch per unit effort \n(fish caught/trip)",
                         na.value = "grey100", limits= c(0, 600))+
     theme_classic()+
     annotation_scale(location= "bl", width_hint= 0.2, pad_y = unit(1, "cm"), pad_x = unit(0.7, "cm"))+
     annotation_north_arrow(location= "tr", which_north= "true", width= unit(1, "cm"),  
                           height= unit(1, "cm"),style= north_arrow_fancy_orienteering(), 
                           pad_x = unit(0.5, "cm"), pad_y = unit(0.1, "cm"))+
     xlab("Longitude")+
     ylab("Latitude")+
     ggtitle("CINMS CPFV Catch Per Unit Effort (fish/trips)", 
              subtitle= paste("Year", i, sep = "-"))

  
  ggsave(x, path= path_plot_heatmap, file=paste0("CINMS_heatmap_same_scale_", i, ".png") )
}
```



###For after state designation MPAs
```{r}
##Graphing and printing
for(i in unique(CINMS_fishing_blocks_pelagic_2004_2007$year)){
  x<- ggplot()+
      geom_sf(data=CINMS_shpfile_blocks, fill="white")+
      geom_sf(data= subset(CINMS_fishing_blocks_pelagic_2004_2007, year==i & year>2003 & year<2007),
              aes(fill=CPUE))+
      geom_sf(data=CINMS_state_MPA, color="black", fill= "darkblue", alpha=0.25)+
      scale_fill_gradientn(colours=rev(magma(6)),
                         name="Catch per unit effort \n(fish caught/trip)",
                         na.value = "grey100", limits= c(0, 600))+
      theme_classic()+
      annotation_scale(location= "bl", width_hint= 0.2, pad_y = unit(1, "cm"), pad_x = unit(0.7, "cm"))+
      annotation_north_arrow(location= "tr", which_north= "true", width= unit(1, "cm"),  
                           height= unit(1, "cm"),style= north_arrow_fancy_orienteering(), 
                           pad_x = unit(0.5, "cm"), pad_y = unit(0.1, "cm"))+
      xlab("Longitude")+
      ylab("Latitude")+
      ggtitle("CINMS CPFV Catch Per Unit Effort (fish/trips)", 
              subtitle= paste("Year", i, sep = "-"))
  
  ggsave(x, path= path_plot_heatmap, file=paste0("CINMS_heatmap_same_scale_", i, ".png") )
}
```

### For after fed designation of MPAs
```{r}
##Graphing and printing
for(i in unique(CINMS_fishing_blocks_pelagic_2007$year)){
  x<- ggplot()+
      geom_sf(data=CINMS_shpfile_blocks, fill="white")+
      geom_sf(data= subset(CINMS_fishing_blocks_pelagic_2007, year==i & year>2006), aes(fill=CPUE))+
              geom_sf(data=CINMS_state_MPA, color="black", fill= "darkblue", alpha=0.25)+
              geom_sf(data=CINMS_fed_MPA, color="black", fill="darkgreen", alpha= 0.25)+
      scale_fill_gradientn(colours=rev(magma(6)),
                         name="Catch per unit effort \n(fish caught/trip)",
                         na.value = "grey100", limits= c(0, 600))+
      theme_classic()+
      annotation_scale(location= "bl", width_hint= 0.2, pad_y = unit(1, "cm"), pad_x = unit(0.7, "cm"))+
      annotation_north_arrow(location= "tr", which_north= "true", width= unit(1, "cm"),  
                           height= unit(1, "cm"),style= north_arrow_fancy_orienteering(), 
                           pad_x = unit(0.5, "cm"), pad_y = unit(0.1, "cm"))+
      xlab("Longitude")+
      ylab("Latitude")+
      ggtitle("CINMS CPFV Catch Per Unit Effort (fish/trips)", 
              subtitle= paste("Year", i, sep = "-"))
  
  ggsave(x, path= path_plot_heatmap, file=paste0("CINMS_heatmap_same_scale_", i, ".png") )
}
```

#Same scale/Proportion total
###Path
```{r}
path_plot_heatmap<-"\\\\10.74.13.28/ci-users/Vanessa.Van.Deusen/R_projects/CPFV_pelagics/Data/graphs/CINMS/CINMS_heatmaps_by_year/proportion_total_same_scale"

```

##"For loop" graphing
iterative loop for printing each block 
###For before MPA designation state= 2004
```{r}
##Graphing and saving
for(i in unique(CINMS_fishing_blocks_pelagic_2004$year)){
  x<-ggplot()+
     geom_sf(data=CINMS_shpfile_blocks, fill="white")+
     geom_sf(data= subset(CINMS_fishing_blocks_pelagic_2004, year==i & year<2004), aes(fill=proportional_catch))+
     scale_fill_gradientn(colours=rev(magma(6)),
                         name="Proportional Catch \n(# fish caught/ \nmaximum # fish caught)",
                         na.value = "grey100", limits= c(0, 1))+
     theme_classic()+
     annotation_scale(location= "bl", width_hint= 0.2, pad_y = unit(1, "cm"), pad_x = unit(0.7, "cm"))+
     annotation_north_arrow(location= "tr", which_north= "true", width= unit(1, "cm"),  
                           height= unit(1, "cm"),style= north_arrow_fancy_orienteering(), 
                           pad_x = unit(0.5, "cm"), pad_y = unit(0.1, "cm"))+
     xlab("Longitude")+
     ylab("Latitude")+
     ggtitle("CINMS CPFV Proportional Catch (# fish caught/maximum # fish ever caught)", 
              subtitle= paste("Year", i, sep = "-"))

  
  ggsave(x, path= path_plot_heatmap, file=paste0("CINMS_heatmap_proportion_same_scale_", i, ".png") )
}
```



###For after state designation MPAs
```{r}
##Graphing and printing
for(i in unique(CINMS_fishing_blocks_pelagic_2004_2007$year)){
  x<- ggplot()+
      geom_sf(data=CINMS_shpfile_blocks, fill="white")+
      geom_sf(data= subset(CINMS_fishing_blocks_pelagic_2004_2007, year==i & year>2003 & year<2007),
              aes(fill=proportional_catch))+
      geom_sf(data=CINMS_state_MPA, color="black", fill= "darkblue", alpha=0.25)+
      scale_fill_gradientn(colours=rev(magma(6)),
                         name="Proportional Catch \n(# fish caught/ \nmaximum # fish caught)",
                         na.value = "grey100", limits= c(0, 1))+
      theme_classic()+
      annotation_scale(location= "bl", width_hint= 0.2, pad_y = unit(1, "cm"), pad_x = unit(0.7, "cm"))+
      annotation_north_arrow(location= "tr", which_north= "true", width= unit(1, "cm"),  
                           height= unit(1, "cm"),style= north_arrow_fancy_orienteering(), 
                           pad_x = unit(0.5, "cm"), pad_y = unit(0.1, "cm"))+
      xlab("Longitude")+
      ylab("Latitude")+
      ggtitle("CINMS CPFV Proportional Catch (# fish caught/maximum # fish ever caught)", 
              subtitle= paste("Year", i, sep = "-"))
  
  ggsave(x, path= path_plot_heatmap, file=paste0("CINMS_heatmap_proportion_same_scale_", i, ".png") )
}
```

### For after fed designation of MPAs
```{r}
##Graphing and printing
for(i in unique(CINMS_fishing_blocks_pelagic_2007$year)){
  x<- ggplot()+
      geom_sf(data=CINMS_shpfile_blocks, fill="white")+
      geom_sf(data= subset(CINMS_fishing_blocks_pelagic_2007, year==i & year>2006), aes(fill=proportional_catch))+
              geom_sf(data=CINMS_state_MPA, color="black", fill= "darkblue", alpha=0.25)+
              geom_sf(data=CINMS_fed_MPA, color="black", fill="darkgreen", alpha= 0.25)+
      scale_fill_gradientn(colours=rev(magma(6)),
                         name="Proportional Catch \n(# fish caught/ \nmaximum # fish caught)",
                         na.value = "grey100", limits= c(0, 1))+
      theme_classic()+
      annotation_scale(location= "bl", width_hint= 0.2, pad_y = unit(1, "cm"), pad_x = unit(0.7, "cm"))+
      annotation_north_arrow(location= "tr", which_north= "true", width= unit(1, "cm"),  
                           height= unit(1, "cm"),style= north_arrow_fancy_orienteering(), 
                           pad_x = unit(0.5, "cm"), pad_y = unit(0.1, "cm"))+
      xlab("Longitude")+
      ylab("Latitude")+
      ggtitle("CINMS CPFV Proportional Catch (# fish caught/maximum # fish ever caught)", 
              subtitle= paste("Year", i, sep = "-"))
  
  ggsave(x, path= path_plot_heatmap, file=paste0("CINMS_heatmap_proportion_same_scale_", i, ".png") )
}
```



#___________________________________
#Unused code 

Below is the way that I did previously before I calculated CPUE_t for each individual trip. Previously, I calculated CPUE by taking the average of catch and people per year-- this prevents the ability to run stats on means because it treats all measurements as a single sample. 

Agg by year- CPUE_t & CPUE_p
```{r}
CINMS_sum_years<-aggregate(CPFV_pelagics_allblocks_rm$, by=list(year=CPFV_pelagics_allblocks_rm$year), FUN=sum)
CINMS_sum_years<-rename(CINMS_sum_years, "totalcatch"= "x")
CINMS_count_years<-aggregate(CPFV_pelagics_allblocks_rm$total_caught, by=list(year=CPFV_pelagics_allblocks_rm$year), FUN=length)
CINMS_count_years<-rename(CINMS_count_years, "number_of_trips"= "x")
CINMS_sum_people_years<-aggregate(CPFV_pelagics_allblocks_rm$n_fishers, by=list(year=CPFV_pelagics_allblocks_rm$year), FUN=sum)
CINMS_sum_people_years<-rename(CINMS_sum_people_years, "number_of_fishers"= "x")

pelagicsCINMS_caught_years<-CINMS_sum_years%>% left_join(CINMS_count_years, by= "year", relationship= "one-to-one", na_matches = "never")
pelagicsCINMS_year_rm<-pelagicsCINMS_caught_years%>% left_join(CINMS_sum_people_years, by= "year", relationship= "one-to-one", na_matches = "never")
pelagicsCINMS_year_rm<-pelagicsCINMS_year_rm %>%
  mutate(CPUE_t= total_catch/number_of_trips)
pelagicsCINMS_year_rm<-pelagicsCINMS_year_rm %>%
  mutate(CPUE_p= total_catch/number_of_fishers)
```

Agg by year & block- CPUE_t & CPUE_p
```{r}
##aggregating by block and year
CINMS_sum_year_block<-aggregate(CPFV_pelagics_allblocks_rm$total_caught, by=list(year=CPFV_pelagics_allblocks_rm$year, block_id=CPFV_pelagics_allblocks_rm$block_id), FUN=sum)
CINMS_sum_year_block<-rename(CINMS_sum_year_block, "total_catch"= "x")
CINMS_sum_year_block<- replace(CINMS_sum_year_block, is.na(CINMS_sum_year_block), 0)

CINMS_count_year_block<-aggregate(CPFV_pelagics_allblocks_rm$total_caught, by=list(year=CPFV_pelagics_allblocks_rm$year, block_id=CPFV_pelagics_allblocks_rm$block_id), FUN=length)
CINMS_count_year_block<-rename(CINMS_count_year_block, "number_of_trips"= "x")
CINMS_count_year_block<- replace(CINMS_count_year_block, is.na(CINMS_count_year_block), 0)

CINMS_sum_people_year_block<-aggregate(CPFV_pelagics_allblocks_rm$n_fishers, by=list(year=CPFV_pelagics_allblocks_rm$year, block_id=CPFV_pelagics_allblocks_rm$block_id), FUN=sum)
CINMS_sum_people_year_block<-rename(CINMS_sum_people_year_block, "number_of_fishers"= "x")

pelagicsCINMS_year_block_caught<-CINMS_sum_year_block%>% left_join(CINMS_count_year_block, by= c("year", "block_id"), relationship = "one-to-one", na_matches = "never")
pelagicsCINMS_year_block_rm<- pelagicsCINMS_year_block_caught%>% left_join(CINMS_sum_people_year_block,by= c("year", "block_id"), relationship = "one-to-one", na_matches = "never")

pelagicsCINMS_year_block_rm<-pelagicsCINMS_year_block_rm %>%
  mutate(CPUE_t= total_catch/number_of_trips)
pelagicsCINMS_year_block_rm<-pelagicsCINMS_year_block_rm %>%
  mutate(CPUE_p= total_catch/number_of_fishers)
```

Agg species, year, block- CPUE_t & CPUE_p
```{r}
CINMS_sum_species_year_block<-aggregate(CPFV_pelagics_allblocks_rm$total_caught, by=list(year=CPFV_pelagics_allblocks_rm$year, species=CPFV_pelagics_allblocks_rm$species_name, species_type=CPFV_pelagics_allblocks_rm$species_type, block_id= CPFV_pelagics_allblocks_rm$block_id), FUN=sum)
CINMS_sum_species_year_block<-rename(CINMS_sum_species_year_block, "total_catch"= "x")
CINMS_sum_species_year_block$year<-as.character(CINMS_sum_species_year_block$year)

CINMS_count_species_year_block<-aggregate(CPFV_pelagics_allblocks_rm$total_caught, by=list(year=CPFV_pelagics_allblocks_rm$year, species=CPFV_pelagics_allblocks_rm$species_name, species_type=CPFV_pelagics_allblocks_rm$species_type, block_id= CPFV_pelagics_allblocks_rm$block_id), FUN=length)
CINMS_count_species_year_block<-rename(CINMS_count_species_year_block, "number_of_trips"= "x")
CINMS_count_species_year_block$year<-as.character(CINMS_count_species_year_block$year)

CINMS_sum_people_species_year_block<-aggregate(CPFV_pelagics_allblocks_rm$n_fishers, by=list(year=CPFV_pelagics_allblocks_rm$year, species=CPFV_pelagics_allblocks_rm$species_name, species_type=CPFV_pelagics_allblocks_rm$species_type, block_id= CPFV_pelagics_allblocks_rm$block_id), FUN=sum)
CINMS_sum_people_species_year_block<-rename(CINMS_sum_people_species_year_block, "number_of_fishers"= "x")
CINMS_sum_people_species_year_block$year<-as.character(CINMS_sum_people_species_year_block$year)

pelagicsCINMS_species_year_block_caught<-CINMS_sum_species_year_block%>% left_join(CINMS_count_species_year_block, by= c("year", "block_id", "species", "species_type"), relationship = "one-to-one", na_matches = "never")
pelagicsCINMS_species_year_block_rm<-pelagicsCINMS_species_year_block_caught %>% left_join(CINMS_sum_people_species_year_block, by= c("year", "block_id", "species", "species_type"), relationship = "one-to-one", na_matches = "never")

pelagicsCINMS_species_year_block_rm<-pelagicsCINMS_species_year_block_rm %>%
  mutate(CPUE_t= total_catch/number_of_trips)
pelagicsCINMS_species_year_block_rm<-pelagicsCINMS_species_year_block_rm %>%
  mutate(CPUE_p= total_catch/number_of_fishers)
```

Agg by species type & year- CPUE_t & CPUE_p
```{r}
CINMS_sum_year_species<-aggregate(CPFV_pelagics_allblocks_rm$total_caught, by=list(species_type=CPFV_pelagics_allblocks_rm$species_type, year=CPFV_pelagics_allblocks_rm$year), FUN=sum)
CINMS_sum_year_species<-rename(CINMS_sum_year_species, "total_catch"= "x")

CINMS_count_year_species<-aggregate(CPFV_pelagics_allblocks_rm$total_caught, by=list(species_type=CPFV_pelagics_allblocks_rm$species_type, year=CPFV_pelagics_allblocks_rm$year), FUN=length)
CINMS_count_year_species<-rename(CINMS_count_year_species, "number_of_trips"= "x")

CINMS_sum_people_year_species<-aggregate(CPFV_pelagics_allblocks_rm$n_fishers, by=list(year=CPFV_pelagics_allblocks_rm$year, species_type=CPFV_pelagics_allblocks_rm$species_type), FUN=sum)
CINMS_sum_people_year_species<-rename(CINMS_sum_people_year_species, "number_of_fishers"= "x")

pelagicsCINMS_species_year_type_caught<-CINMS_sum_year_species%>% left_join(CINMS_count_year_species, by= c("year", "species_type"), relationship = "one-to-one", na_matches = "never")
pelagicsCINMS_species_year_type_rm<-pelagicsCINMS_species_year_type_caught %>% left_join(CINMS_sum_people_year_species, by= c("year", "species_type"), relationship = "one-to-one", na_matches = "never")

pelagicsCINMS_species_year_type_rm<-pelagicsCINMS_species_year_type_rm%>%
  mutate(CPUE_t= total_catch/number_of_trips)
pelagicsCINMS_species_year_type_rm<-pelagicsCINMS_species_year_type_rm%>%
  mutate(CPUE_p= total_catch/number_of_fishers)
```



Below is the way that I did previously before I calculated CPUE_t for each individual trip. Previously, I calculated CPUE by taking the average of catch and people per year-- this prevents the ability to run stats on means because it treats all measurements as a single sample. 

Agg by year- CPUE_t & CPUE_p
```{r}
CINMS_sum_years<-aggregate(CPFV_pelagics_allblocks_rm$, by=list(year=CPFV_pelagics_allblocks_rm$year), FUN=sum)
CINMS_sum_years<-rename(CINMS_sum_years, "totalcatch"= "x")
CINMS_count_years<-aggregate(CPFV_pelagics_allblocks_rm$total_caught, by=list(year=CPFV_pelagics_allblocks_rm$year), FUN=length)
CINMS_count_years<-rename(CINMS_count_years, "number_of_trips"= "x")
CINMS_sum_people_years<-aggregate(CPFV_pelagics_allblocks_rm$n_fishers, by=list(year=CPFV_pelagics_allblocks_rm$year), FUN=sum)
CINMS_sum_people_years<-rename(CINMS_sum_people_years, "number_of_fishers"= "x")

pelagicsCINMS_caught_years<-CINMS_sum_years%>% left_join(CINMS_count_years, by= "year", relationship= "one-to-one", na_matches = "never")
pelagicsCINMS_year_rm<-pelagicsCINMS_caught_years%>% left_join(CINMS_sum_people_years, by= "year", relationship= "one-to-one", na_matches = "never")
pelagicsCINMS_year_rm<-pelagicsCINMS_year_rm %>%
  mutate(CPUE_t= total_catch/number_of_trips)
pelagicsCINMS_year_rm<-pelagicsCINMS_year_rm %>%
  mutate(CPUE_p= total_catch/number_of_fishers)
```

Agg by year & block- CPUE_t & CPUE_p
```{r}
##aggregating by block and year
CINMS_sum_year_block<-aggregate(CPFV_pelagics_allblocks_rm$total_caught, by=list(year=CPFV_pelagics_allblocks_rm$year, block_id=CPFV_pelagics_allblocks_rm$block_id), FUN=sum)
CINMS_sum_year_block<-rename(CINMS_sum_year_block, "total_catch"= "x")
CINMS_sum_year_block<- replace(CINMS_sum_year_block, is.na(CINMS_sum_year_block), 0)

CINMS_count_year_block<-aggregate(CPFV_pelagics_allblocks_rm$total_caught, by=list(year=CPFV_pelagics_allblocks_rm$year, block_id=CPFV_pelagics_allblocks_rm$block_id), FUN=length)
CINMS_count_year_block<-rename(CINMS_count_year_block, "number_of_trips"= "x")
CINMS_count_year_block<- replace(CINMS_count_year_block, is.na(CINMS_count_year_block), 0)

CINMS_sum_people_year_block<-aggregate(CPFV_pelagics_allblocks_rm$n_fishers, by=list(year=CPFV_pelagics_allblocks_rm$year, block_id=CPFV_pelagics_allblocks_rm$block_id), FUN=sum)
CINMS_sum_people_year_block<-rename(CINMS_sum_people_year_block, "number_of_fishers"= "x")

pelagicsCINMS_year_block_caught<-CINMS_sum_year_block%>% left_join(CINMS_count_year_block, by= c("year", "block_id"), relationship = "one-to-one", na_matches = "never")
pelagicsCINMS_year_block_rm<- pelagicsCINMS_year_block_caught%>% left_join(CINMS_sum_people_year_block,by= c("year", "block_id"), relationship = "one-to-one", na_matches = "never")

pelagicsCINMS_year_block_rm<-pelagicsCINMS_year_block_rm %>%
  mutate(CPUE_t= total_catch/number_of_trips)
pelagicsCINMS_year_block_rm<-pelagicsCINMS_year_block_rm %>%
  mutate(CPUE_p= total_catch/number_of_fishers)
```

Agg species, year, block- CPUE_t & CPUE_p
```{r}
CINMS_sum_species_year_block<-aggregate(CPFV_pelagics_allblocks_rm$total_caught, by=list(year=CPFV_pelagics_allblocks_rm$year, species=CPFV_pelagics_allblocks_rm$species_name, species_type=CPFV_pelagics_allblocks_rm$species_type, block_id= CPFV_pelagics_allblocks_rm$block_id), FUN=sum)
CINMS_sum_species_year_block<-rename(CINMS_sum_species_year_block, "total_catch"= "x")
CINMS_sum_species_year_block$year<-as.character(CINMS_sum_species_year_block$year)

CINMS_count_species_year_block<-aggregate(CPFV_pelagics_allblocks_rm$total_caught, by=list(year=CPFV_pelagics_allblocks_rm$year, species=CPFV_pelagics_allblocks_rm$species_name, species_type=CPFV_pelagics_allblocks_rm$species_type, block_id= CPFV_pelagics_allblocks_rm$block_id), FUN=length)
CINMS_count_species_year_block<-rename(CINMS_count_species_year_block, "number_of_trips"= "x")
CINMS_count_species_year_block$year<-as.character(CINMS_count_species_year_block$year)

CINMS_sum_people_species_year_block<-aggregate(CPFV_pelagics_allblocks_rm$n_fishers, by=list(year=CPFV_pelagics_allblocks_rm$year, species=CPFV_pelagics_allblocks_rm$species_name, species_type=CPFV_pelagics_allblocks_rm$species_type, block_id= CPFV_pelagics_allblocks_rm$block_id), FUN=sum)
CINMS_sum_people_species_year_block<-rename(CINMS_sum_people_species_year_block, "number_of_fishers"= "x")
CINMS_sum_people_species_year_block$year<-as.character(CINMS_sum_people_species_year_block$year)

pelagicsCINMS_species_year_block_caught<-CINMS_sum_species_year_block%>% left_join(CINMS_count_species_year_block, by= c("year", "block_id", "species", "species_type"), relationship = "one-to-one", na_matches = "never")
pelagicsCINMS_species_year_block_rm<-pelagicsCINMS_species_year_block_caught %>% left_join(CINMS_sum_people_species_year_block, by= c("year", "block_id", "species", "species_type"), relationship = "one-to-one", na_matches = "never")

pelagicsCINMS_species_year_block_rm<-pelagicsCINMS_species_year_block_rm %>%
  mutate(CPUE_t= total_catch/number_of_trips)
pelagicsCINMS_species_year_block_rm<-pelagicsCINMS_species_year_block_rm %>%
  mutate(CPUE_p= total_catch/number_of_fishers)
```

Agg by species type & year- CPUE_t & CPUE_p
```{r}
CINMS_sum_year_species<-aggregate(CPFV_pelagics_allblocks_rm$total_caught, by=list(species_type=CPFV_pelagics_allblocks_rm$species_type, year=CPFV_pelagics_allblocks_rm$year), FUN=sum)
CINMS_sum_year_species<-rename(CINMS_sum_year_species, "total_catch"= "x")

CINMS_count_year_species<-aggregate(CPFV_pelagics_allblocks_rm$total_caught, by=list(species_type=CPFV_pelagics_allblocks_rm$species_type, year=CPFV_pelagics_allblocks_rm$year), FUN=length)
CINMS_count_year_species<-rename(CINMS_count_year_species, "number_of_trips"= "x")

CINMS_sum_people_year_species<-aggregate(CPFV_pelagics_allblocks_rm$n_fishers, by=list(year=CPFV_pelagics_allblocks_rm$year, species_type=CPFV_pelagics_allblocks_rm$species_type), FUN=sum)
CINMS_sum_people_year_species<-rename(CINMS_sum_people_year_species, "number_of_fishers"= "x")

pelagicsCINMS_species_year_type_caught<-CINMS_sum_year_species%>% left_join(CINMS_count_year_species, by= c("year", "species_type"), relationship = "one-to-one", na_matches = "never")
pelagicsCINMS_species_year_type_rm<-pelagicsCINMS_species_year_type_caught %>% left_join(CINMS_sum_people_year_species, by= c("year", "species_type"), relationship = "one-to-one", na_matches = "never")

pelagicsCINMS_species_year_type_rm<-pelagicsCINMS_species_year_type_rm%>%
  mutate(CPUE_t= total_catch/number_of_trips)
pelagicsCINMS_species_year_type_rm<-pelagicsCINMS_species_year_type_rm%>%
  mutate(CPUE_p= total_catch/number_of_fishers)
```

Graphing
Bar graph- species type, year
Years with PDO over +1 are 1983, 1986, 1987, 1993, 1997
MHWs with an average intensity over 2 STEVs were in 2015, 2006, and 1995
```{r}
pelagicsCINMS_species_year_rm$year<-as.numeric(pelagicsCINMS_species_year_rm$year)
ggplot(pelagicsCINMS_species_year_rm, aes(year, total, fill=species_type))+ 
  geom_col()+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust=1))+
  theme(legend.position="top")+
  theme(legend.title=element_blank())+
  xlab("Year")+
  ylab("Total Caught")+
  scale_x_continuous(breaks=seq(1980,2020,1))+
  theme(legend.text=element_text(size=7))+
  #adding lines for mpa designation years
  geom_vline(aes(xintercept = 2004), pelagicsCINMS_species_year_rm, colour="black", size=1)+
  geom_vline(aes(xintercept = 2007), pelagicsCINMS_species_year_rm, colour="black", size=1)+
  #adding MHW events 
  geom_vline(aes(xintercept = 2015), pelagicsCINMS_species_year_rm, colour="black", size=0.75, linetype=2)+
  geom_vline(aes(xintercept = 2006), pelagicsCINMS_species_year_rm, colour="black", size=0.75, linetype=2)+
  geom_vline(aes(xintercept = 1995), pelagicsCINMS_species_year_rm, colour="black", size=0.75, linetype=2)+
  #adding lines where ENSO over 1.5 
  annotate("rect", xmin = 1982, xmax = 1983, ymin = -Inf, ymax = Inf, fill= "blue",
        alpha = .2)+
  annotate("rect", xmin = 1986, xmax = 1987, ymin = -Inf, ymax = Inf, fill= "blue",
        alpha = .2)+
  annotate("rect", xmin = 1991, xmax = 1993, ymin = -Inf, ymax = Inf, fill= "blue",
        alpha = .2)+
  annotate("rect", xmin = 1997, xmax = 1998, ymin = -Inf, ymax = Inf, fill= "blue",
        alpha = .2)+
  annotate("rect", xmin = 2015, xmax = 2016, ymin = -Inf, ymax = Inf, fill= "blue",
        alpha = .2)+
   #adding shading where PDO is over 1 
  geom_vline(aes(xintercept = 1983), pelagicsCINMS_species_year_rm, colour="black", size=0.75, linetype=3)+
  geom_vline(aes(xintercept = 1986), pelagicsCINMS_species_year_rm, colour="black", size=0.75, linetype=3)+
  geom_vline(aes(xintercept = 1993), pelagicsCINMS_species_year_rm, colour="black", size=0.75, linetype=3)+
  geom_vline(aes(xintercept = 1997), pelagicsCINMS_species_year_rm, colour="black", size=0.75, linetype=3)+
  labs(title = str_wrap("CPFV catch overtime in CINMS CDFW fishing blocks", 70))+
   theme(plot.title = element_text(hjust = 0.5))

ggsave("CINMS_bar_pelagic.jpeg", width= 30, height= 20, units= "cm", path = path_plot)

```

Line Plot- species type, year

CPUE_t_aggregate; PDO color coded-- +1/-1
```{r}
##Facet wrapped 
pelagicsCINMS_species_year_type_rm$year<-as.character(pelagicsCINMS_species_year_type_rm$year)
pelagicsCINMS_species_year_type_rm$year<-as.numeric(pelagicsCINMS_species_year_type_rm$year)
designation_MHW_ENSO_years$year<-as.numeric(designation_MHW_ENSO_years$year)

ggplot()+ 
  geom_line(data=pelagicsCINMS_species_year_type_rm, aes(x=year, y=CPUE_t),size=1, color= "black")+
  facet_wrap(~species_type)+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust=1))+
  theme(legend.position="top")+
  theme(legend.title=element_blank())+
  ylab("Catch per Unit Effort (fish caught per trip)")+
  xlab("Years")+
  scale_x_continuous(breaks=seq(1980,2020,5))+
  theme(legend.text=element_text(size=7))+
  theme(strip.text.x = element_text(size = 15))+
  geom_vline(data=subset(designation_MHW_ENSO_years, Event=="MHW"|Event== "ENSO"), 
           mapping= aes(xintercept=year), color="gray61",  linetype="dotted", size=1)+
  geom_vline(data=subset(designation_MHW_ENSO_years, Event=="Federal_MPA_Designation"), 
             mapping= aes(xintercept=year),color="gray41", size=1)+
  geom_vline(data=subset(designation_MHW_ENSO_years, Event=="State_MPA_Desingation"), 
             mapping= aes(xintercept=year),color="gray41", size=1)+
   annotate("rect", xmin = 1983, xmax = 1984, ymin = -Inf, ymax = Inf, fill= "red",
        alpha = .1)+
   annotate("rect", xmin = 1986, xmax = 1988, ymin = -Inf, ymax = Inf, fill= "red",
        alpha = .1)+
   annotate("rect", xmin = 1993, xmax = 1994, ymin = -Inf, ymax = Inf, fill= "red",
        alpha = .1)+
   annotate("rect", xmin = 1997, xmax = 1998, ymin = -Inf, ymax = Inf, fill= "red",
        alpha = .1)+
   annotate("rect", xmin = 1999, xmax = 2002, ymin = -Inf, ymax = Inf, fill= "blue",
        alpha = .1)+
   annotate("rect", xmin = 2008, xmax = 2014, ymin = -Inf, ymax = Inf, fill= "blue",
        alpha = .1)

ggsave("CINMS_line_pelagic_strong_pdo_CPUEt.jpeg", width= 30, height= 20, units= "cm", path = path_plot)
```
CPUE_t_aggregate; PDO color coded-- All non-neutral PDO
```{r}
##Facet wrapped 
pelagicsCINMS_species_year_type_rm$year<-as.character(pelagicsCINMS_species_year_type_rm$year)
pelagicsCINMS_species_year_type_rm$year<-as.numeric(pelagicsCINMS_species_year_type_rm$year)
designation_MHW_ENSO_years$year<-as.numeric(designation_MHW_ENSO_years$year)

ggplot()+ 
  geom_line(data=pelagicsCINMS_species_year_type_rm, aes(x=year, y=CPUE_t),size=1, color= "black")+
  facet_wrap(~species_type)+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust=1))+
  theme(legend.position="top")+
  theme(legend.title=element_blank())+
  ylab("Catch per Unit Effort (fish caught per trip)")+
  xlab("Years")+
  scale_x_continuous(breaks=seq(1980,2020,5))+
  theme(legend.text=element_text(size=7))+
  theme(strip.text.x = element_text(size = 15))+
  geom_vline(data=subset(designation_MHW_ENSO_years, Event=="MHW"|Event== "ENSO"), 
           mapping= aes(xintercept=year), color="gray61",  linetype="dotted", size=1)+
  geom_vline(data=subset(designation_MHW_ENSO_years, Event=="Federal_MPA_Designation"), 
             mapping= aes(xintercept=year),color="gray41", size=1)+
  geom_vline(data=subset(designation_MHW_ENSO_years, Event=="State_MPA_Desingation"), 
             mapping= aes(xintercept=year),color="gray41", size=1)+
   annotate("rect", xmin = 1980, xmax = 1982, ymin = -Inf, ymax = Inf, fill= "red",
        alpha = .1)+
   annotate("rect", xmin = 1983, xmax = 1985, ymin = -Inf, ymax = Inf, fill= "red",
        alpha = .1)+
   annotate("rect", xmin = 1986, xmax = 1988, ymin = -Inf, ymax = Inf, fill= "red",
        alpha = .1)+
   annotate("rect", xmin = 1992, xmax = 1994, ymin = -Inf, ymax = Inf, fill= "red",
        alpha = .1)+
   annotate("rect", xmin = 1995, xmax = 1998, ymin = -Inf, ymax = Inf, fill= "red",
        alpha = .1)+
   annotate("rect", xmin = 2003, xmax = 2004, ymin = -Inf, ymax = Inf, fill= "red",
        alpha = .1)+
  annotate("rect", xmin = 2014, xmax = 2017, ymin = -Inf, ymax = Inf, fill= "red",
        alpha = .1)+
  annotate("rect", xmin = 1982, xmax = 1983, ymin = -Inf, ymax = Inf, fill= "blue",
        alpha = .1)+
  annotate("rect", xmin = 1989, xmax = 1992, ymin = -Inf, ymax = Inf, fill= "blue",
        alpha = .1)+
  annotate("rect", xmin = 1994, xmax = 1995, ymin = -Inf, ymax = Inf, fill= "blue",
        alpha = .1)+
  annotate("rect", xmin = 1998, xmax = 2003, ymin = -Inf, ymax = Inf, fill= "blue",
        alpha = .1)+
  annotate("rect", xmin = 2004, xmax = 2014, ymin = -Inf, ymax = Inf, fill= "blue",
        alpha = .1)+
  annotate("rect", xmin = 2018, xmax = 2020, ymin = -Inf, ymax = Inf, fill= "blue",
        alpha = .1)
ggsave("CINMS_line_pelagic_all_pdo_CPUEt.jpeg", width= 30, height= 20, units= "cm", path = path_plot)
```

CPUE_p_aggregate; PDO color coded-- +1/-1
```{r}
##Facet wrapped 
pelagicsCINMS_species_year_type_rm$year<-as.character(pelagicsCINMS_species_year_type_rm$year)
pelagicsCINMS_species_year_type_rm$year<-as.numeric(pelagicsCINMS_species_year_type_rm$year)
designation_MHW_ENSO_years$year<-as.numeric(designation_MHW_ENSO_years$year)

ggplot()+ 
  geom_line(data=pelagicsCINMS_species_year_type_rm, aes(x=year, y=CPUE_p),size=1, color= "black")+
  facet_wrap(~species_type)+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust=1))+
  theme(legend.position="top")+
  theme(legend.title=element_blank())+
  ylab("Catch per Unit Effort (fish caught per fisher)")+
  xlab("Years")+
  scale_x_continuous(breaks=seq(1980,2020,5))+
  theme(legend.text=element_text(size=7))+
  theme(strip.text.x = element_text(size = 15))+
  geom_vline(data=subset(designation_MHW_ENSO_years, Event=="MHW"|Event== "ENSO"), 
           mapping= aes(xintercept=year), color="gray61",  linetype="dotted", size=1)+
  geom_vline(data=subset(designation_MHW_ENSO_years, Event=="Federal_MPA_Designation"), 
             mapping= aes(xintercept=year),color="gray41", size=1)+
  geom_vline(data=subset(designation_MHW_ENSO_years, Event=="State_MPA_Desingation"), 
             mapping= aes(xintercept=year),color="gray41", size=1)+
   annotate("rect", xmin = 1983, xmax = 1984, ymin = -Inf, ymax = Inf, fill= "red",
        alpha = .1)+
   annotate("rect", xmin = 1986, xmax = 1988, ymin = -Inf, ymax = Inf, fill= "red",
        alpha = .1)+
   annotate("rect", xmin = 1993, xmax = 1994, ymin = -Inf, ymax = Inf, fill= "red",
        alpha = .1)+
   annotate("rect", xmin = 1997, xmax = 1998, ymin = -Inf, ymax = Inf, fill= "red",
        alpha = .1)+
   annotate("rect", xmin = 1999, xmax = 2002, ymin = -Inf, ymax = Inf, fill= "blue",
        alpha = .1)+
   annotate("rect", xmin = 2008, xmax = 2014, ymin = -Inf, ymax = Inf, fill= "blue",
        alpha = .1)

ggsave("CINMS_line_pelagic_strong_pdo_CPUEp.jpeg", width= 30, height= 20, units= "cm", path = path_plot)
```

CPUE_p_aggregate; PDO color coded-- All non-neutral PDO
```{r}
##Facet wrapped 
pelagicsCINMS_species_year_type_rm$year<-as.character(pelagicsCINMS_species_year_type_rm$year)
pelagicsCINMS_species_year_type_rm$year<-as.numeric(pelagicsCINMS_species_year_type_rm$year)
designation_MHW_ENSO_years$year<-as.numeric(designation_MHW_ENSO_years$year)

ggplot()+ 
  geom_line(data=pelagicsCINMS_species_year_type_rm, aes(x=year, y=CPUE_p),size=1, color= "black")+
  facet_wrap(~species_type)+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust=1))+
  theme(legend.position="top")+
  theme(legend.title=element_blank())+
  ylab("Catch per Unit Effort (fish caught per fisher)")+
  xlab("Years")+
  scale_x_continuous(breaks=seq(1980,2020,5))+
  theme(legend.text=element_text(size=7))+
  theme(strip.text.x = element_text(size = 15))+
  geom_vline(data=subset(designation_MHW_ENSO_years, Event=="MHW"|Event== "ENSO"), 
           mapping= aes(xintercept=year), color="gray61",  linetype="dotted", size=1)+
  geom_vline(data=subset(designation_MHW_ENSO_years, Event=="Federal_MPA_Designation"), 
             mapping= aes(xintercept=year),color="gray41", size=1)+
  geom_vline(data=subset(designation_MHW_ENSO_years, Event=="State_MPA_Desingation"), 
             mapping= aes(xintercept=year),color="gray41", size=1)+
   annotate("rect", xmin = 1980, xmax = 1982, ymin = -Inf, ymax = Inf, fill= "red",
        alpha = .1)+
   annotate("rect", xmin = 1983, xmax = 1985, ymin = -Inf, ymax = Inf, fill= "red",
        alpha = .1)+
   annotate("rect", xmin = 1986, xmax = 1988, ymin = -Inf, ymax = Inf, fill= "red",
        alpha = .1)+
   annotate("rect", xmin = 1992, xmax = 1994, ymin = -Inf, ymax = Inf, fill= "red",
        alpha = .1)+
   annotate("rect", xmin = 1995, xmax = 1998, ymin = -Inf, ymax = Inf, fill= "red",
        alpha = .1)+
   annotate("rect", xmin = 2003, xmax = 2004, ymin = -Inf, ymax = Inf, fill= "red",
        alpha = .1)+
  annotate("rect", xmin = 2014, xmax = 2017, ymin = -Inf, ymax = Inf, fill= "red",
        alpha = .1)+
  annotate("rect", xmin = 1982, xmax = 1983, ymin = -Inf, ymax = Inf, fill= "blue",
        alpha = .1)+
  annotate("rect", xmin = 1989, xmax = 1992, ymin = -Inf, ymax = Inf, fill= "blue",
        alpha = .1)+
  annotate("rect", xmin = 1994, xmax = 1995, ymin = -Inf, ymax = Inf, fill= "blue",
        alpha = .1)+
  annotate("rect", xmin = 1998, xmax = 2003, ymin = -Inf, ymax = Inf, fill= "blue",
        alpha = .1)+
  annotate("rect", xmin = 2004, xmax = 2014, ymin = -Inf, ymax = Inf, fill= "blue",
        alpha = .1)+
  annotate("rect", xmin = 2018, xmax = 2020, ymin = -Inf, ymax = Inf, fill= "blue",
        alpha = .1)
ggsave("CINMS_line_pelagic_all_pdo_CPUEp.jpeg", width= 30, height= 20, units= "cm", path = path_plot)
```


Stacked line plots
CPUE_t_aggregate; Stacked Line Graph and gas prices 
```{r}
pelagicsCINMS_year_rm$year<-as.numeric(as.character(pelagicsCINMS_year_rm$year))
plot1<- ggplot()+ 
  geom_line(data=pelagicsCINMS_year_rm, aes(x=year, y=CPUE_t),size=1, color= "black")+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust=1))+
  theme(legend.position="top")+
  theme(legend.title=element_blank())+
  ylab("Catch per Unit Effort (fish caught per trip)")+
  xlab("Years")+
  scale_x_continuous(breaks=seq(1980,2020,5))+
  theme(legend.text=element_text(size=7))+
  theme(strip.text.x = element_text(size = 15))+
  geom_vline(data=subset(designation_MHW_ENSO_years, Event=="MHW"|Event== "ENSO"), 
           mapping= aes(xintercept=year), color="gray61",  linetype="dotted", size=1)+
  geom_vline(data=subset(designation_MHW_ENSO_years, Event=="Federal_MPA_Designation"), 
             mapping= aes(xintercept=year),color="gray41", size=1)+
  geom_vline(data=subset(designation_MHW_ENSO_years, Event=="State_MPA_Desingation"), 
             mapping= aes(xintercept=year),color="gray41", size=1)+
   annotate("rect", xmin = 1980, xmax = 1982, ymin = -Inf, ymax = Inf, fill= "red",
        alpha = .1)+
   annotate("rect", xmin = 1983, xmax = 1985, ymin = -Inf, ymax = Inf, fill= "red",
        alpha = .1)+
   annotate("rect", xmin = 1986, xmax = 1988, ymin = -Inf, ymax = Inf, fill= "red",
        alpha = .1)+
   annotate("rect", xmin = 1992, xmax = 1994, ymin = -Inf, ymax = Inf, fill= "red",
        alpha = .1)+
   annotate("rect", xmin = 1995, xmax = 1998, ymin = -Inf, ymax = Inf, fill= "red",
        alpha = .1)+
   annotate("rect", xmin = 2003, xmax = 2004, ymin = -Inf, ymax = Inf, fill= "red",
        alpha = .1)+
  annotate("rect", xmin = 2014, xmax = 2017, ymin = -Inf, ymax = Inf, fill= "red",
        alpha = .1)+
  annotate("rect", xmin = 1982, xmax = 1983, ymin = -Inf, ymax = Inf, fill= "blue",
        alpha = .1)+
  annotate("rect", xmin = 1989, xmax = 1992, ymin = -Inf, ymax = Inf, fill= "blue",
        alpha = .1)+
  annotate("rect", xmin = 1994, xmax = 1995, ymin = -Inf, ymax = Inf, fill= "blue",
        alpha = .1)+
  annotate("rect", xmin = 1998, xmax = 2003, ymin = -Inf, ymax = Inf, fill= "blue",
        alpha = .1)+
  annotate("rect", xmin = 2004, xmax = 2014, ymin = -Inf, ymax = Inf, fill= "blue",
        alpha = .1)+
  annotate("rect", xmin = 2018, xmax = 2020, ymin = -Inf, ymax = Inf, fill= "blue",
        alpha = .1)
plot1

plot2<-ggplot(gas_adjusted2020, aes(Year, adjust_price))+
  geom_line(size=1)+
  theme_bw()+
  theme(plot.margin = unit(c(5,5,5,5), 'points'))+
  scale_x_continuous(breaks=seq(1980,2020,1))+
  theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust=1))+
   scale_x_continuous(breaks=seq(1980,2020,10))+
  theme(legend.text=element_text(size=7))+
  theme(strip.text.x = element_text(size = 15))+
  labs(y = paste0("Inflation Adjusted Gas Price ($/gallon)"))+
  xlab("Year")
plot2
plotstacked<-ggarrange(plot1, plot2, nrow=2)
plotstacked
ggsave("CINMS_stacked_gas_all_CPUEt.jpeg", plot= plotstacked, width = 7, height = 8, units="in", path = path_plot)
```