---
title: "CPFV_pelagics_data_clean"
author: "Vanessa Van Deusen"
date: "2023-11-06"
output: html_document
---
project: 2023 cpfv rec fishing and pelagics re: response to letters as part of MPA review
PI: Jenny Selgrath
________________________________________________
Data input: cpfv_merged_no_pii.csv; blocks.csv; MFDE_port_historic.csv; MFDE_Species_historic.csv
----------
see read.me file in Data and Bin folders for more information about data and code. Code adapted/pulled from existing code provided by Chris Free (UCSB) via email on 10/2/2023
_________________________________________________
data output: CDFW_1980_2020_cpfv_logbook_data.Rds, CPFV_pelagic_species_subset.Rds
-------------
#Inital setup
## Loading libraries
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readr)
library(tidyverse)
library(FishLife)
library(freeR)
library(dplyr)
library(janitor)
library(ggplot2)
library(lubridate)
path_out="\\\\10.74.13.28/ci-users/Vanessa.Van.Deusen/R_projects/CPFV_pelagics/Data"
```

## Importing data
```{r}
##CPFV data-- ID for vessels included, PII removed
cpfv_merged_uniqueID<-read_csv("//10.74.13.28/ci-users/Vanessa.Van.Deusen/R_projects/CPFV_pelagics/Data/cpfv_merged_uniqueID.csv")
#includes "id_vessel"= v_1, v_2, etc.

##Associated key building dataframes
blocks <- read_csv("//10.74.13.28/ci-users/Vanessa.Van.Deusen/R_projects/CPFV_pelagics/Data/blocks.csv") 
### Column names: "OBJECTID"      "BLOCK10_ID"    "AreaMi"        "Acres"         "Shape__Area"   "Shape__Length"

port_DF <- read_csv("//10.74.13.28/ci-users/Vanessa.Van.Deusen/R_projects/CPFV_pelagics/Data/MFDE_port_historic.csv")
###Column names: "Port Area"        "Port Name"        "Port Code"        "Discontinue Date" "...5"

species_DF<-read_csv("//10.74.13.28/ci-users/Vanessa.Van.Deusen/R_projects/CPFV_pelagics/Data/MFDE_Species_historic.csv")
###Column names: "Species Name"     "Species ID"       "Species Group"    "CCL Category"     "Discontinue Date" "...6"
```

## Creating key data
```{r}
block_key <- blocks %>% 
 # st_drop_geometry()%>% 
  rename("block_id"= "BLOCK10_ID", 
         "block_areaMi"= "AreaMi", 
         "block_Acres"="Acres", 
         "block_shape_area"= "Shape__Area", 
         "block_shape_length"= "Shape__Length") %>%
  mutate(block_id= as.numeric(block_id))

port_key<- port_DF %>% 
  clean_names("snake")%>%
  rename(port= port_name, 
         port_complex= port_area)%>%
  select(-c(x5))


species_key<-species_DF %>% 
  clean_names("snake") %>%
  rename("species_code"= "species_id", 
         "species_discontinue_date"= "discontinue_date")%>% 
  select(-c(x6))%>%
  mutate(species_code = as.numeric(species_code))
```


#-----
#Demographics on species, methods, and bait (dataset from 1980-2020)
## Which species groups are most frequently targeted by recreational fishers?
```{r}
target_n <- rev(sort(nrow(cpfv_merged_uniqueID)-freeR::complete(cpfv_merged_uniqueID %>% select(TargetSpeciesLingcod:TargetSpeciesMiscBay))))
head(target_n)
```

## Which fishing method is most frequently used by recreational fishers?
```{r}
method_n <- rev(sort(nrow(cpfv_merged_uniqueID)-freeR::complete(cpfv_merged_uniqueID %>% select(FishingMethodTrolling:FishingMethodOther))))
head(method_n)
```
## Which bait is most frequently used by recreational fishers?
```{r}
bait_n <- rev(sort(nrow(cpfv_merged_uniqueID)-freeR::complete(cpfv_merged_uniqueID %>% select(BaitUsedAnchoviesLive:BaitUsedOtherDead))))
head(bait_n)
```

##Table format
###Specific species 
```{r}
table(cpfv_merged_uniqueID$TargetSpeciesLingcod)
table(cpfv_merged_no_pii$TargetSpeciesOther)
table(cpfv_merged_no_pii$TargetSpeciesRockfishes)
table(cpfv_merged_no_pii$TargetSpeciesSalmon)
table(cpfv_merged_no_pii$TargetSpeciesSharks)
table(cpfv_merged_no_pii$TargetSpeciesStripedBass)
table(cpfv_merged_no_pii$TargetSpeciesSturgeon)
table(cpfv_merged_no_pii$TargetSpeciesTuna)
table(cpfv_merged_no_pii$TargetSpeciesPotluck)
table(cpfv_merged_no_pii$TargetSpeciesMiscCoastal)
table(cpfv_merged_no_pii$TargetSpeciesMiscBay)
table(cpfv_merged_no_pii$TargetSpeciesMiscOffshore)
```

###Specific method
```{r}
table(cpfv_merged_no_pii$FishingMethodTrolling)
table(cpfv_merged_no_pii$FishingMethodAnchored)
table(cpfv_merged_no_pii$FishingMethodDiving)
table(cpfv_merged_no_pii$FishingMethodDrifting)
table(cpfv_merged_no_pii$FishingMethodLightTackle)
table(cpfv_merged_no_pii$FishingMethodMooching)
table(cpfv_merged_no_pii$FishingMethodOther)
```

###Specific bait
```{r}
table(cpfv_merged_no_pii$BaitUsedAnchoviesDead)
table(cpfv_merged_no_pii$BaitUsedAnchoviesLive)
table(cpfv_merged_no_pii$BaitUsedOtherDead)
table(cpfv_merged_no_pii$BaitUsedOtherLive)
table(cpfv_merged_no_pii$BaitUsedSardinesDead)
table(cpfv_merged_no_pii$BaitUsedSardinesLive)
table(cpfv_merged_no_pii$BaitUsedSquidDead)
table(cpfv_merged_no_pii$BaitUsedSquidLive)
```




#-----
#Clean data 
```{r}
 data_clean <- cpfv_merged_uniqueID %>% 
#____Cleaning____________________________ 
#Step 1.1: Initial Column Standardization and Name Cleaning --------
  janitor::clean_names("snake") %>% 
  rename(
    date=                     log_date,
    month=                    log_month,         
    day=                      log_day,
    year=                     log_year,
    block_id=                 block,
    hm_fished=                hours_minutes_fished,
    comm_name_orig=           species, 
    temp_f=                   temperature,
    depth_ft=                 depth,
    n_fishers=                number_of_fishers,
    hrs_fished=               hours_fished,
    n_kept=                   number_kept,
    n_released=               number_released,
    n_lost_to_sea_lions=      number_lost_to_sea_lions,
    n_caught_by_crew=         number_of_fish_caught_by_crew,
    n_crew_fished=            number_of_crew_fished
    ) %>% 
  # Step 1.2: Ensuring that date/time and count columns are in the correct format 
  mutate(
    #Convert characters to Date objects
    date=              lubridate::mdy(date),
    date_received=     lubridate::mdy(date_received),
    date_submitted=    lubridate::mdy(date_submitted), 
    #Ensure number columns are coded as numeric
    across(.cols= c(month, year, port_code, block_id, depth_ft, temp_f, n_fishers, n_caught_by_crew, 
               n_crew_fished, hrs_fished, n_kept, n_released, hrs_fished, hm_fished, species_code),
           .fns= as.numeric), 
    across(.cols= c(n_kept, n_caught_by_crew, n_crew_fished, n_fishers, n_released), 
           .fns= ~replace_na(.x, 0))
    ) %>%
  # Step 1.3: Removing white space from common names and trip types 
  mutate(comm_name_orig=stringr::str_squish(comm_name_orig), 
         trip_type = stringr::str_to_sentence(trip_type)
         )%>%
#___Joins____________________________
# Step 2.1: Spatial Joins-- Ports and Blocks
  left_join(port_key, by="port_code", 
            relationship = "many-to-one", 
            na_matches = "never" ) %>%
  mutate(port= ifelse(is.na(port), "Invalid", port), #returns "Invalid" if there is an NA here
    ) %>%
  left_join(block_key %>% 
              select("block_id", "block_areaMi", "block_Acres"), 
            by="block_id") %>%
  
  # Step 5: Species Key Joins 
  left_join(species_key %>% select(species_code, species_name, species_group, species_discontinue_date), 
            by=c("species_code")) %>%
#___Consolidating Columns______________________   
# Step 3.1: Consolidating Col
    
##If there is interest in including oarfish in the analysis: 
####    mutate(species_code=recode(species_code, "Oarfish"="") %>% as.numeric(.)) %>% 
####    mutate(species_name=ifelse(species_code==2665 , "Oarfish", species_name))%>%
   mutate(
     target_species= paste( #puts the name of the species, if not the target, puts "NA", then puts all the targets in a string to consolidate to a single column 
       ifelse(!is.na(target_species_rockfishes), "Rockfish", "NA"),
         target_species_misc_coastal=ifelse(!is.na(target_species_misc_coastal), "Misc. coastal", "NA"),
         ifelse(!is.na(target_species_other), "Other", "NA"),
         ifelse(!is.na(target_species_lingcod), "Lingcod", "NA"),
         ifelse(!is.na(target_species_tuna), "Tuna", "NA"),
         ifelse(!is.na(target_species_misc_offshore), "Misc. offshore", "NA"),
         ifelse(!is.na(target_species_salmon), "Salmon", "NA"),
         ifelse(!is.na(target_species_potluck), "Potluck", "NA"),
         ifelse(!is.na(target_species_striped_bass), "Striped bass", "NA"),
         ifelse(!is.na(target_species_sharks), "Sharks", "NA"),
         ifelse(!is.na(target_species_sturgeon), "Sturgeon", "NA"),
         ifelse(!is.na(target_species_misc_bay), "Misc. bay", "NA"), 
       sep = ", "
       ),
     fishing_method= paste( #puts the name of the fishing method, if not that type, puts "NA", then puts all the fishing types in a string to consolidate to a single column
        ifelse(!is.na(fishing_method_anchored), "Anchored", "NA"),
        ifelse(!is.na(fishing_method_drifting), "Drifting", "NA"),
        ifelse(!is.na(fishing_method_trolling), "Trolling", "NA"),
        ifelse(!is.na(fishing_method_light_tackle), "Light tackle", "NA"),
        ifelse(!is.na(fishing_method_diving), "Diving", "NA"),
        ifelse(!is.na(fishing_method_other), "Other", "NA"),
        ifelse(!is.na(fishing_method_mooching), "Mooching", "NA"),
      sep = ", " 
      ),
     bait_used= paste( #puts the name of the bait, if not that type, puts "NA", then puts all the bait types in a string to consolidate to a single column
       ifelse(!is.na(bait_used_squid_dead), "Squid (dead)", "NA"),
       ifelse(!is.na(bait_used_sardines_live), "Sardines (live)", "NA"),
       ifelse(!is.na(bait_used_anchovies_live), "Anchovies (live)", "NA"),
       ifelse(!is.na(bait_used_squid_live), "Squid (live)", "NA"),
       ifelse(!is.na(bait_used_other_dead), "Other (dead)", "NA"),
       ifelse(!is.na(bait_used_anchovies_dead), "Anchovies (dead)", "NA"),
       ifelse(!is.na(bait_used_sardines_dead), "Sardines (dead)", "NA"), 
       ifelse(!is.na(bait_used_other_live), "Other (live)", "NA")), 
     sep = ", ") %>%
    mutate(across(c(target_species, fishing_method, bait_used), #Removes the NAs within the string 
                  ~gsub("NA, |, NA", "", .x))) %>%
    
#___Consolidating Columns______________________   
# Step 4.1: Cacluating total fishers, total catch, and days fished 
  mutate(
    total_caught= abs(n_kept+ n_released),
    total_fishers= abs(n_fishers + n_crew_fished),
    days_fished= hrs_fished/24
  ) %>%
  
# Step 4.2: ID generation and column re-ordering  
  mutate(ID= row_number(), 
         logbook_id_use = paste(ID, date, id_vessel, sep="-")
         )%>%
  select(logbook_id_use, 
         year, month, day, total_caught, total_fishers, days_fished, 
         date, date_submitted, date_received,
         port_complex, port_code, port,
         no_activity_month,
         trip_type, non_paying, descending_device, bird_interaction,
         target_species, fishing_method, bait_used, 
         block_id,
         depth_ft, temp_f, 
         departure_time, return_time, hm_fished, hrs_fished, n_fishers, n_crew_fished,
         species_code, species_name,
         n_kept, n_released, n_lost_to_sea_lions, n_caught_by_crew,id_vessel, 
         everything())

```

#Inspect Data
```{r}
# Inspect data
################################################################################

# Inspect
head(data_clean)
str(data_clean)
# na_check <- freeR::complete(data)
# (100 - na_check / nrow(data) * 100) %>% round(., 2)

# Date
range(data_clean$date)
range(data_clean$year)
range(data_clean$month)
range(data_clean$day)
range(data_clean$date_received, na.rm=T)
range(data_clean$date_submitted, na.rm=T) # 1900-01-01 = NA?
range(data_clean$temp_f, na.rm=T) #there are some temperatures which are entered incorrectly-- range from -6 to 740 makes no sense

# Ports
port_key_check <- data_clean %>% 
  select(port_complex, port_code, port) %>% 
  unique() %>% 
  arrange(port_code)

port_invalid<-data_clean%>%
  subset(port=="Invalid")%>%
  select(port_complex, port_code, port)%>%
  unique()%>%
  arrange(port_code)
#write.csv(port_invalid_full, file.path(path_out, "port_invalid_full.csv"))

# Block
block_key_check <- data_clean %>% 
  select(block_id) %>% 
  unique()
sort(block_key_check$block_id[is.na(block_key_check$block_type)])
blocks_wrong<-data_clean%>%
  subset(block_id>897)%>%
  select(block_id, year)%>%
  unique()%>%
  arrange(block_id)
#write.csv(blocks_wrong, file.path(path_out, "blocks_wrong.csv"))

##Looking specifically at one repeatedly misentered block ID that was re-entered 172 times 
block1032_wrong<-data_clean%>% subset(block_id==1032)
write.csv(block1032_wrong, file.path(path_out, "block1032_wrong.csv"))

# Trip type
sort(unique(data_clean$trip_type))
table(data_clean$non_paying) # N, Y
table(data_clean$no_activity_month)

# Descending device
table(data_clean$descending_device) # B, N, Y
table(data_clean$bird_interaction) # B, N, Y

# Species
sort(unique(data_clean$species_code))
sort(unique(data_clean$species_name))
species_key_check <- data_clean %>% 
  select(species_code,species_name, comm_name_orig) %>% 
  unique()
sort(species_key_check$species_code[is.na(species_key_check$species_name)])

species_name_missing<-data_clean%>%
  subset(is.na(data_clean$species_name))%>%
  select(species_code, species_name, comm_name_orig) %>%
 # unique()%>%
  arrange(species_code)
###comparing species names to comm_name_orig
species_key_check_against<-data_clean%>%
  select(species)

###break down of missing species names 
table(species_name_missing$comm_name_orig)
#write.csv(species_name_missing, file.path(path_out, "species_name_missing.csv"))

# Temperature
ggplot(data_clean, aes(y=temp_f)) +
  geom_boxplot() +
  labs(y="Temperature (Â°F)") +
  lims(y=c(0,100)) +
  theme_bw()

hist(data_clean$temp_f)
temp_mistake<-subset(data_clean, temp_f> 100)
view(temp_mistake)
#write.csv(temp_mistake, file.path(path_out, "temp_mistake.csv"))


# Depth
ggplot(data_clean, aes(y=depth_ft)) +
  geom_boxplot() +
  labs(y="Depth (feet)") +
  lims(y=c(0, 500)) +
  theme_bw()
hist(data_clean$depth_ft)

# Times
freeR::uniq(data_clean$departure_time)
freeR::uniq(data_clean$return_time)
freeR::uniq(data_clean$hm_fished)

# Inspect duration
duration_key <- data_clean %>% 
  select(hm_fished, hrs_fished) %>% 
  unique() %>% 
  arrange(hrs_fished)
#Dont understand what is purpose of below
#duration_key_check <- duration_key %>% 
 # mutate(nchar=nchar(hm_fished),
  #       colon_yn=grepl(":", hm_fished)) %>% 
  #rowwise() %>% 
  #mutate(hrs_fished2=conv_hm_to_hr(hm_fished)) %>% 
#  ungroup() %>% 
 # mutate(hrs_check=near(hrs_fished, hrs_fished2, tol=0.0001))

# Target species, fishing method, bait used
table(data_clean$target_species)
table(data$fishing_method)
table(data$bait_used)

```


#Export
```{r}
saveRDS(data_clean, file.path(path_out, "CDFW_1980_2020_cpfv_logbook_data.Rds"))
```

#------
#Subset for Pelagics 

Pelagic species: From Kacy CCA response notes-- "Condition report definition for coastal pelagic and HMF: California barracuda, Pacific bonito, white sea bass, yellowtail, albacore, blue shark, jack mackerel, northern, anchovy, opah, Pacific mackerel, Pacific northern bluefin tuna, Pacific sardine, shortfin mako shark, skipjack tuna, striped marlin, swordfish, thresher shark, white shark, and yellowfin tuna. "

   swordfish,  white shark, and  

Barracuda, California; Bonito, Pacific; Anchovy, northern; **dolphin (fish)**; Mackerel, jack; Mackerel, Pacific;  Marlin, striped; Mackerel, unspecified; Opah; Seabass, white; Shark, blue;Shark, shortfin mako; Shark, thresher; Tuna, albacore; Tuna, bluefin; Tuna, skipjack; Tuna, skipjack, black; Tuna, unspecified ; Tuna, yellowfin; Yellowtail; Sardine, Pacific; Swordfish; Shark, pelagic thresher; Shark, white; Swordfish

swordfish is not within subset of data 
###Selecting pelagics species 
```{r}
pelagic_species <- c("Barracuda, California","Bonito, Pacific", "Anchovy, northern", "dolphin (fish)", "Mackerel, jack", "Mackerel, Pacific", "Marlin, striped", "Mackerel, unspecified", "Opah", "Seabass, white", "Shark, blue", "Shark, shortfin mako", "Shark, thresher", "Tuna, albacore", "Tuna, bluefin", "Tuna, skipjack", "Tuna, skipjack, black", "Tuna, unspecified", "Tuna, yellowfin", "Yellowtail", "Sardine, Pacific", "Shark, pelagic thresher", "Shark, white", "Swordfish")

CPFV_pelagic_subset<- data_clean %>%
  filter(comm_name_orig %in% pelagic_species) %>% #filter out pelagic species
  filter(!is.na(n_fishers), n_fishers !=0) %>% #filter out when there is no recorded number of fishers
  #Categorize species
  mutate(
    species_type = case_when(
      species_name %in% 
        c("Shark, blue","Shark, shortfin mako","Shark, thresher", "Shark, white","Shark, pelagic thresher") 
            ~ "Shark", 
      species_name %in% 
        c("Tuna, albacore", "Tuna, bluefin", "Tuna, skipjack", "Tuna, skipjack, black", "Tuna, unspecified", "Tuna, yellowfin")
            ~ "Tuna", 
      species_name %in%
        c("Mackerel, jack", "Mackerel, Pacific", "Mackerel, unspecified")
            ~ "Mackerel", 
      species_name %in%
        c("Marlin, striped", "Swordfish")
            ~ "Billfish", 
      species_name %in%
        c("Anchovy, northern", "Sardine, Pacific")
            ~ "Baitfish", 
      species_name == "Bonito, Pacific"      ~ "Bonito",
      species_name == "Opah"                ~ "Opah",
      species_name == "Yellowtail"          ~ "Yellowtail"
    ),
    #Calculate effort and CPUE
    CPUE_p = ((total_caught/total_fishers)/days_fished)
  )
  
  
  data_clean%>% subset(comm_name_orig=="Barracuda, California"|
                                              comm_name_orig=="Bonito, Pacific"|
                                              comm_name_orig=="Anchovy, northern"|
                                              comm_name_orig=="dolphin (fish)"|
                                              #comm_name_orig=="Mackerel, jack"|
                                              #comm_name_orig=="Mackerel, Pacific"|
                                              comm_name_orig=="Marlin, striped"|
                                              #comm_name_orig=="Mackerel, unspecified"|
                                              comm_name_orig=="Opah"|
                                              #comm_name_orig=="Seabass, white"|
                                              comm_name_orig=="Shark, blue"|
                                              comm_name_orig=="Shark, shortfin mako"|
                                              comm_name_orig=="Shark, thresher"|
                                              comm_name_orig=="Tuna, albacore"|
                                              comm_name_orig=="Tuna, bluefin"|
                                              comm_name_orig=="Tuna, skipjack"|
                                              comm_name_orig=="Tuna, skipjack, black"|
                                              comm_name_orig=="Tuna, unspecified"|
                                              comm_name_orig=="Tuna, yellowfin"| 
                                              comm_name_orig=="Yellowtail"|
                                              comm_name_orig=="Sardine, Pacific"|
                                              comm_name_orig=="Shark, pelagic thresher"|
                                              comm_name_orig=="Shark, white"|
                                              comm_name_orig=="Swordfish")
```
### Grouping by species type
```{r}
CPFV_pelagic_subset$species_type[CPFV_pelagic_subset$species_name=="Shark, blue" |
                             CPFV_pelagic_subset$species_name=="Shark, shortfin mako"|
                             CPFV_pelagic_subset$species_name=="Shark, thresher"| 
                             CPFV_pelagic_subset$species_name=="Shark, white"|
                             CPFV_pelagic_subset$species_name=="Shark, pelagic thresher"] <- "Shark"
CPFV_pelagic_subset$species_type[CPFV_pelagic_subset$species_name=="Tuna, albacore"|
                             CPFV_pelagic_subset$species_name=="Tuna, bluefin"|
                             CPFV_pelagic_subset$species_name=="Tuna, skipjack"| 
                             CPFV_pelagic_subset$species_name=="Tuna, skipjack, black"|
                             CPFV_pelagic_subset$species_name=="Tuna, unspecified"|
                             CPFV_pelagic_subset$species_name=="Tuna, yellowfin"] <-"Tuna"
CPFV_pelagic_subset$species_type[CPFV_pelagic_subset$species_name=="Mackerel, jack"|
                             CPFV_pelagic_subset$species_name=="Mackerel, Pacific"|
                             CPFV_pelagic_subset$species_name=="Mackerel, unspecified" ] <- "Mackerel"
CPFV_pelagic_subset$species_type[CPFV_pelagic_subset$species_name=="Marlin, striped"|
                             CPFV_pelagic_subset$species_name=="Swordfish"] <- "Billfish"
CPFV_pelagic_subset$species_type[CPFV_pelagic_subset$species_name=="Anchovy, northern"|
                             CPFV_pelagic_subset$species_name=="Sardine, Pacific"] <- "Baitfish"
CPFV_pelagic_subset$species_type[CPFV_pelagic_subset$species_name=="Barracuda, California"] <- "Barracuda"
CPFV_pelagic_subset$species_type[CPFV_pelagic_subset$species_name=="Bonito, Pacific"] <- "Bonito"
CPFV_pelagic_subset$species_type[CPFV_pelagic_subset$species_name=="Opah"] <- "Opah"
CPFV_pelagic_subset$species_type[CPFV_pelagic_subset$species_name=="Yellowtail"] <- "Yellowtail"
```

##Adding caught (crew and customers)+ released for total caught
```{r}
CPFV_pelagic_subset<-CPFV_pelagic_subset %>% 
  mutate(total_caught= n_kept + n_released)
CPFV_pelagic_subset$total_caught<-abs(CPFV_pelagic_subset$total_caught)
```

##Removing rows where n_fishers= 0 | n=fishers=Na
```{r}
CPFV_pelagic_subset<- CPFV_pelagic_subset %>% drop_na("n_fishers")
CPFV_pelagic_subset<-subset(CPFV_pelagic_subset, CPFV_pelagic_subset$n_fishers != 0)
```

##Adding CPUE_p 
```{r}
CPFV_pelagic_subset<-CPFV_pelagic_subset %>% 
  mutate(CPUE_p= total_caught/n_fishers)
```


##Save dataframe
```{r}
saveRDS(CPFV_pelagic_subset, file.path(path_out, "CPFV_pelagic_species_subset.Rds"))
```