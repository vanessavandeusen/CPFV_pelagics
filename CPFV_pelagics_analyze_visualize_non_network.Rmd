---
title: "CPFV_pelagics_analyze_visualize"
author: "Van Deusen"
date: "2023-11-29"
output: html_document
---
project: 2023 cpfv rec fishing and pelagics re: response to letters as part of MPA review
PI: Jenny Selgrath
data input: CDFW_1980_2020_cpfv_logbook_data.Rds
** see read.me file in Data and Bin folders for more information about data and code. Code adapted/pulled from existing code provided by Chris Free (UCSB) via email on 10/2/2023
data output:  

#Inital setup
## Loading libraries
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readr)
library(tidyverse)
library(FishLife)
library(freeR)
library(dplyr)
library(janitor)
library(ggplot2)
library(lubridate)
library(sf)
library(tidyr)
library(viridis)
path_out="\\\\10.74.13.28/ci-users/Vanessa.Van.Deusen/R_projects/CPFV_pelagics/Data"
```

## Importing data
```{r cars}
CPFV_data<-readRDS("C:/Users/vanessa.van.deusen/Desktop/Vanessa_non_network/R_projects/CPFV_pelagics/Data/CDFW_1980_2020_cpfv_logbook_data.Rds")

blocks <- read_csv("C:/Users/vanessa.van.deusen/Desktop/Vanessa_non_network/R_projects/CPFV_pelagics/Data/blocks.csv")

CINMS_fishing_blocks<- read_csv("C:/Users/vanessa.van.deusen/Desktop/Vanessa_non_network/R_projects/CPFV_pelagics/Data/CINMS_fishingblock_intersect.csv")

SoCal_fishing_blocks<-st_read("C:/Users/vanessa.van.deusen/Desktop/Outputs/SoCal_fishingblocks/Pt_Conception_SoCal_Commercial_Fishing_Blocks.shp")
SoCal_fishing_blocks<-rename(SoCal_fishing_blocks, "block_id"= "BLOCK10_ID")
SoCal_fishing_blocks = subset(SoCal_fishing_blocks, select = -c(total) )

CINMS<-st_read("C:/Users/vanessa.van.deusen/Desktop/Vanessa_non_network/ArcGIS_Projects/CPFV_pelagics/Data/CINMS/CINMS.shp")

```

#Subsetting
Pelagic species: From Kacy CCA response notes-- "Condition report definition for coastal pelagic and HMF: California barracuda, Pacific bonito, white sea bass, yellowtail, albacore, blue shark, jack mackerel, northern, anchovy, opah, Pacific mackerel, Pacific northern bluefin tuna, Pacific sardine, shortfin mako shark, skipjack tuna, striped marlin, swordfish, thresher shark, white shark, and yellowfin tuna. "

   swordfish,  white shark, and  

Barracuda, California; Bonito, Pacific; Anchovy, northern; **dolphin (fish)**; Mackerel, jack; Mackerel, Pacific;  Marlin, striped; Mackerel, unspecified; Opah; Seabass, white; Shark, blue;Shark, shortfin mako; Shark, thresher; Tuna, albacore; Tuna, bluefin; Tuna, skipjack; Tuna, skipjack, black; Tuna, unspecified ; Tuna, yellowfin; Yellowtail; Sardine, Pacific; Swordfish; Shark, pelagic thresher; Shark, white; Swordfish

swordfish is not within subset of data 
##Selecting pelagics species 
```{r}
unique(CPFV_data$species_name)
CPFV_pelagics<-CPFV_data%>% subset(comm_name_orig=="Barracuda, California"|
                                              comm_name_orig=="Bonito, Pacific"|
                                              comm_name_orig=="Anchovy, northern"|
                                              comm_name_orig=="dolphin (fish)"|
                                              comm_name_orig=="Mackerel, jack"|
                                              comm_name_orig=="Mackerel, Pacific"|
                                              comm_name_orig=="Marlin, striped"|
                                              comm_name_orig=="Mackerel, unspecified"|
                                              comm_name_orig=="Opah"|
                                              #comm_name_orig=="Seabass, white"|
                                              comm_name_orig=="Shark, blue"|
                                              comm_name_orig=="Shark, shortfin mako"|
                                              comm_name_orig=="Shark, thresher"|
                                              comm_name_orig=="Tuna, albacore"|
                                              comm_name_orig=="Tuna, bluefin"|
                                              comm_name_orig=="Tuna, skipjack"|
                                              comm_name_orig=="Tuna, skipjack, black"|
                                              comm_name_orig=="Tuna, unspecified"|
                                              comm_name_orig=="Tuna, yellowfin"| 
                                              comm_name_orig=="Yellowtail"|
                                              comm_name_orig=="Sardine, Pacific"|
                                              comm_name_orig=="Shark, pelagic thresher"|
                                              comm_name_orig=="Shark, white"|
                                              comm_name_orig=="Swordfish")

CPFV_pelagics$species_type[CPFV_pelagics$species_name=="Shark, blue" |
                             CPFV_pelagics$species_name=="Shark, shortfin mako"|
                             CPFV_pelagics$species_name=="Shark, thresher"| 
                             CPFV_pelagics$species_name=="Shark, white"|
                             CPFV_pelagics$species_name=="Shark, pelagic thresher"] <- "Shark"
CPFV_pelagics$species_type[CPFV_pelagics$species_name=="Tuna, albacore"|
                             CPFV_pelagics$species_name=="Tuna, bluefin"|
                             CPFV_pelagics$species_name=="Tuna, skipjack"| 
                             CPFV_pelagics$species_name=="Tuna, skipjack, black"|
                             CPFV_pelagics$species_name=="Tuna, unspecified"|
                             CPFV_pelagics$species_name=="Tuna, yellowfin"] <-"Tuna"
CPFV_pelagics$species_type[CPFV_pelagics$species_name=="Mackerel, jack"|
                             CPFV_pelagics$species_name=="Mackerel, Pacific"|
                             CPFV_pelagics$species_name=="Mackerel, unspecified" ] <- "Mackerel"
CPFV_pelagics$species_type[CPFV_pelagics$species_name=="Marlin, striped"|
                             CPFV_pelagics$species_name=="Swordfish"] <- "Billfish"
CPFV_pelagics$species_type[CPFV_pelagics$species_name=="Anchovy, northern"|
                             CPFV_pelagics$species_name=="Sardine, Pacific"] <- "Baitfish"
CPFV_pelagics$species_type[CPFV_pelagics$species_name=="Barracuda, California"] <- "Barracuda"
CPFV_pelagics$species_type[CPFV_pelagics$species_name=="Bonito, Pacific"] <- "Bonito"
CPFV_pelagics$species_type[CPFV_pelagics$species_name=="Opah"] <- "Opah"
CPFV_pelagics$species_type[CPFV_pelagics$species_name=="Yellowtail"] <- "Yellowtail"
```


## Subsetting by MPA blocks
Footprint= 707 and 708
Gull island= 710 and 709
Santa Barbara= 764 and 765
```{r}
CPFV_pelagics_mpa<- CPFV_pelagics%>%
  subset(block_id==707|
           block_id==708|
           block_id==710|
           block_id==709|
           block_id==764|
           block_id==765)
CPFV_pelagics_mpa$year<-as.factor(CPFV_pelagics_mpa$year)
CPFV_pelagics_footprint<-CPFV_pelagics%>% subset(block_id==707|block_id==708)
CPFV_pelagics_gullisland<- CPFV_pelagics%>% subset(block_id==710|block_id==709)
CPFV_pelagics_santabarbara<- CPFV_pelagics%>% subset(block_id==764|block_id==765)
```

##Subsetting by CINMS blocks 
```{r}
unique(CINMS_fishing_blocks[,c("BLOCK10_ID")])
CPFV_pelagics_allblocks<- CPFV_pelagics%>% subset(block_id==744|
                                       block_id==745|
                                       block_id==764|
                                       block_id==765|
                                       block_id==766|
                                       block_id==667|
                                       block_id==668|
                                       block_id==670|
                                       block_id==671|
                                       block_id==672|
                                       block_id==683|
                                       block_id==684|
                                       block_id==685|
                                       block_id==686|
                                       block_id==687|
                                       block_id==688|
                                       block_id==689|
                                       block_id==690|
                                       block_id==691|
                                       block_id==706|
                                       block_id==707|
                                       block_id==708|
                                       block_id==709|
                                       block_id==710|
                                       block_id==711|
                                       block_id==712|
                                       block_id==713|
                                       block_id==714|
                                       block_id==729|
                                       block_id==730|
                                       block_id==731)

```

##Subsetting by Southern California Blocks 

903(San Diego- MEX border)
```{r}
CPFV_pelagics_socal<- CPFV_pelagics%>% subset(block_id>=651 & block_id<=903)
CPFV_pelagics_socal$year<-as.factor(CPFV_pelagics_socal$year)
```


#Swordfish QA/QC
```{r}
##Swordfish
swordfish_code<-subset(CPFV_data, species_code=="91")
#should put in cleaning code:
swordfish_code$total_caught<-swordfish_code$n_kept+swordfish_code$n_released+swordfish_code$n_lost_to_sea_lions+swordfish_code$n_caught_by_crew
swordfish_aggregate_block<-aggregate(swordfish_code$total_caught, by=list(block_id=swordfish_code$block_id), FUN=sum)
swordfish_aggregate_block<-rename(swordfish_aggregate_block, "total_caught"="x")

#write.csv(swordfish_aggregate_block,file='\\\\10.74.13.28/ci-users/Vanessa.Van.Deusen/R_projects/CPFV_pelagics/Data/swordfish_aggregate_block.csv')

```

#----------
#Inital graph across time
Output from subsetting: 
-- CPFV_pelagics= dataframe subsetted to only include pelagic species 
-- CPFV_pelagics_mpa= dataframe subsetted to only include pelagic species within the Footprint, Gull Island, and Santa Barbara MPAs 
----- CPFV_pelagics_footprint= dataframe subsetted to only include pelagic species within the Footprint MPA
----- CPFV_pelagics_gullisland= dataframe subsetted to only include pelagic species within the Gull Island MPA
----- CPFV_pelagics_santabarbara= dataframe subsetted to only include pelagics within the Santa Barbara MPA
-- CPFV_pelagics_allblocks= dataframe subsetted to only include pelagic species in the blocks within CINMS
-- CPFV_pelagics_socal= dataframe subsetted to only include pelagic species in the fishing blocks from Point Conception to the MEX border. This is consistent with the blocks outlined as being part of Southern California by CDFW

El Nino years that had an index over 1.5 include those listed below. Data pulled from MEI NOAA data set (https://psl.noaa.gov/enso/mei/)
1982-1983; 1986-1987; 1991-1993; 1997-1998; 2015-2016

##MPA Blocks Only
###Year
####Creating dataframe summed by year
```{r}
pelagicsmpa_total<-aggregate(CPFV_pelagics_mpa$n_kept, by=list(year=CPFV_pelagics_mpa$year), FUN=sum)
pelagicsmpa_total
pelagicsmpa_total<-rename(pelagicsmpa_total, "total"= "x")
pelagicsmpa_total$year<-as.factor(pelagicsmpa_total$year)

```

####Graphing total trend by year
```{r}
ggplot(pelagicsmpa_total, aes(year, total))+ 
  geom_col()+
  #geom_point()+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  xlab("Year")+
  ylab("Total Catch")+
  ggtitle("Total pelagic catch within Gull Island, Footprint, and Santa Barbara Island MPAs")+
  geom_vline(xintercept=which(pelagicsmpa_total$year == "2004"), colour="blue")+
  geom_vline(xintercept=which(pelagicsmpa_total$year == '2007'), colour="red")
```

###Year and Block
####Creating dataframe summed by year and block
```{r}
pelagicsmpa_total_block_year<-aggregate(CPFV_pelagics_mpa$n_kept, by=list(year=CPFV_pelagics_mpa$year, block_id=CPFV_pelagics_mpa$block_id), FUN=sum)
pelagicsmpa_total_block_year<-rename(pelagicsmpa_total_block_year, "total"= "x")
pelagicsmpa_total_block_year$year<-as.factor(pelagicsmpa_total_block_year$year)
```


####Graphing total trend by block and year
```{r}
ggplot(pelagicsmpa_total_block_year, aes(year, total))+ 
  geom_col()+
  #geom_point()+
  facet_wrap(~block_id)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  geom_vline(xintercept=which(pelagicsmpa_total_block_year$year == '2004'), colour="blue")+
  geom_vline(xintercept=which(pelagicsmpa_total_block_year$year == '2007'), colour="red")
```
###Year, species, block
#### Create dataframe summed by species, year, and block
```{r}
pelagicsmpa_species_block_year<-aggregate(CPFV_pelagics_mpa$n_kept, by=list(year=CPFV_pelagics_mpa$year, block_id=CPFV_pelagics_mpa$block_id, species=CPFV_pelagics_mpa$species_name, species_type=CPFV_pelagics_mpa$species_type), FUN=sum)
pelagicsmpa_species_block_year<-rename(pelagicsmpa_species_block_year, "total"= "x")
pelagicsmpa_species_block_year$year<-as.character(pelagicsmpa_species_block_year$year)

```

####**Graphing total trend by species and year
#####Bar graph
```{r}
pelagicsmpa_species_block_year$year<-as.numeric(pelagicsmpa_species_block_year$year)
ggplot(pelagicsmpa_species_block_year, aes(year, total, fill=species_type))+ 
  #geom_point()+
  geom_col()+
  #facet_wrap(~species_group)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust=1))+
  theme(legend.position="top")+
  theme(legend.title=element_blank())+
  xlab("Year")+
  ylab("Total Caught")+
  scale_x_continuous(breaks=seq(1980,2020,1))+
  theme(legend.text=element_text(size=7))+
  #adding lines for mpa designation years
  geom_vline(aes(xintercept = 2004), pelagicsmpa_species_block_year, colour="black", size=1)+
  geom_vline(aes(xintercept = 2007), pelagicsmpa_species_block_year, colour="black", size=1)+
  #adding lines for years where ENSO index was >1.5 
  geom_vline(aes(xintercept = 1991), pelagicsmpa_species_block_year, colour="black", size=0.75, linetype=3)+ 
  geom_vline(aes(xintercept = 1986), pelagicsmpa_species_block_year, colour="black", size=0.75, linetype=3)+
  geom_vline(aes(xintercept = 1997), pelagicsmpa_species_block_year, colour="black", size=0.75, linetype=3)+
  geom_vline(aes(xintercept = 2015), pelagicsmpa_species_block_year, colour="black", size=0.75, linetype=3)+
  geom_vline(aes(xintercept = 1982), pelagicsmpa_species_block_year, colour="black", size=0.75, linetype=3)+
  labs(title = str_wrap("CPFV catch overtime in CDFW fishing blocks encompassing Footprint, Gull island, and Santa Barbara MPAs within CINMS", 70))+
   theme(plot.title = element_text(hjust = 0.5))
```

###----------
#CINMS Blocks Only
###Year, species, block
####Creating dataframe summed by year
```{r}
pelagicsCINMS_total<-aggregate(CPFV_pelagics_allblocks$n_kept, by=list(year=CPFV_pelagics_allblocks$year), FUN=sum)
pelagicsCINMS_total<-rename(pelagicsCINMS_total, "total"= "x")
pelagicsCINMS_total$year<-as.factor(pelagicsCINMS_total$year)

```

#### Create dataframe summed by species, year, and block
```{r}
pelagicsCINMS_species_block_year<-aggregate(CPFV_pelagics_allblocks$n_kept, by=list(year=CPFV_pelagics_allblocks$year, block_id=CPFV_pelagics_allblocks$block_id, species=CPFV_pelagics_allblocks$species_name, species_type=CPFV_pelagics_allblocks$species_type), FUN=sum)
pelagicsCINMS_species_block_year<-rename(pelagicsCINMS_species_block_year, "total"= "x")
pelagicsCINMS_species_block_year$year<-as.character(pelagicsCINMS_species_block_year$year)

```

####**Graphing total trend by species and year
```{r}
pelagicsCINMS_species_block_year$year<-as.numeric(pelagicsCINMS_species_block_year$year)
ggplot(pelagicsCINMS_species_block_year, aes(year, total, fill=species_type))+ 
  #geom_point()+
  geom_col()+
  #facet_wrap(~species_group)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust=1))+
  theme(legend.position="top")+
  theme(legend.title=element_blank())+
  xlab("Year")+
  ylab("Total Caught")+
  scale_x_continuous(breaks=seq(1980,2020,1))+
  theme(legend.text=element_text(size=7))+
  #adding lines for mpa designation years
  geom_vline(aes(xintercept = 2004), pelagicsCINMS_species_block_year, colour="black", size=1)+
  geom_vline(aes(xintercept = 2007), pelagicsCINMS_species_block_year, colour="black", size=1)+
  #adding lines for years where ENSO index was >1.5 
  geom_vline(aes(xintercept = 1991), pelagicsCINMS_species_block_year, colour="black", size=0.75, linetype=3)+ 
  geom_vline(aes(xintercept = 1986), pelagicsCINMS_species_block_year, colour="black", size=0.75, linetype=3)+
  geom_vline(aes(xintercept = 1997), pelagicsCINMS_species_block_year, colour="black", size=0.75, linetype=3)+
  geom_vline(aes(xintercept = 2015), pelagicsCINMS_species_block_year, colour="black", size=0.75, linetype=3)+
  geom_vline(aes(xintercept = 1982), pelagicsCINMS_species_block_year, colour="black", size=0.75, linetype=3)+
  labs(title = str_wrap("CPFV catch overtime across CINMS fishing blocks", 70))+
   theme(plot.title = element_text(hjust = 0.5))
```
###Species specific
####TUNA trend by species and year
```{r}
Tuna_CINMS_species_block_year <-subset(pelagicsCINMS_species_block_year, species_type=="Tuna")
Tuna_CINMS_species_block_year$year<-as.numeric(Tuna_CINMS_species_block_year$year)
ggplot(Tuna_CINMS_species_block_year, aes(year, total, fill=species))+ 
  #geom_point()+
  geom_col()+
  #facet_wrap(~species_group)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust=1))+
  theme(legend.position="top")+
  theme(legend.title=element_blank())+
  xlab("Year")+
  ylab("Total Caught")+
  scale_x_continuous(breaks=seq(1980,2020,1))+
  theme(legend.text=element_text(size=7))+
  #adding lines for mpa designation years
  geom_vline(aes(xintercept = 2004), pelagicsCINMS_species_block_year, colour="black", size=1)+
  geom_vline(aes(xintercept = 2007), pelagicsCINMS_species_block_year, colour="black", size=1)+
  #adding lines for years where ENSO index was >1.5 
  geom_vline(aes(xintercept = 1991), pelagicsCINMS_species_block_year, colour="black", size=0.75, linetype=3)+ 
  geom_vline(aes(xintercept = 1986), pelagicsCINMS_species_block_year, colour="black", size=0.75, linetype=3)+
  geom_vline(aes(xintercept = 1997), pelagicsCINMS_species_block_year, colour="black", size=0.75, linetype=3)+
  geom_vline(aes(xintercept = 2015), pelagicsCINMS_species_block_year, colour="black", size=0.75, linetype=3)+
  geom_vline(aes(xintercept = 1982), pelagicsCINMS_species_block_year, colour="black", size=0.75, linetype=3)+
  labs(title = str_wrap("CPFV Tuna catch overtime across CINMS fishing blocks", 70))+
   theme(plot.title = element_text(hjust = 0.5))
```
####BARRACUDA 
```{r}
Barracuda_CINMS_species_block_year <-subset(pelagicsCINMS_species_block_year, species_type=="Barracuda")
Barracuda_CINMS_species_block_year$year<-as.numeric(Barracuda_CINMS_species_block_year$year)
ggplot(Barracuda_CINMS_species_block_year, aes(year, total, fill=species))+ 
  #geom_point()+
  geom_col()+
  #facet_wrap(~species_group)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust=1))+
  theme(legend.position="top")+
  theme(legend.title=element_blank())+
  xlab("Year")+
  ylab("Total Caught")+
  scale_x_continuous(breaks=seq(1980,2020,1))+
  theme(legend.text=element_text(size=7))+
  #adding lines for mpa designation years
  geom_vline(aes(xintercept = 2004), pelagicsCINMS_species_block_year, colour="black", size=1)+
  geom_vline(aes(xintercept = 2007), pelagicsCINMS_species_block_year, colour="black", size=1)+
  #adding lines for years where ENSO index was >1.5 
  geom_vline(aes(xintercept = 1991), pelagicsCINMS_species_block_year, colour="black", size=0.75, linetype=3)+ 
  geom_vline(aes(xintercept = 1986), pelagicsCINMS_species_block_year, colour="black", size=0.75, linetype=3)+
  geom_vline(aes(xintercept = 1997), pelagicsCINMS_species_block_year, colour="black", size=0.75, linetype=3)+
  geom_vline(aes(xintercept = 2015), pelagicsCINMS_species_block_year, colour="black", size=0.75, linetype=3)+
  geom_vline(aes(xintercept = 1982), pelagicsCINMS_species_block_year, colour="black", size=0.75, linetype=3)+
  labs(title = str_wrap("CPFV Barracuda catch overtime across CINMS fishing blocks", 70))+
   theme(plot.title = element_text(hjust = 0.5))
```
####BONITO 
```{r}
Bonito_CINMS_species_block_year <-subset(pelagicsCINMS_species_block_year, species_type=="Bonito")
Bonito_CINMS_species_block_year$year<-as.numeric(Bonito_CINMS_species_block_year$year)
ggplot(Bonito_CINMS_species_block_year, aes(year, total, fill=species))+ 
  #geom_point()+
  geom_col()+
  #facet_wrap(~species_group)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust=1))+
  theme(legend.position="top")+
  theme(legend.title=element_blank())+
  xlab("Year")+
  ylab("Total Caught")+
  scale_x_continuous(breaks=seq(1980,2020,1))+
  theme(legend.text=element_text(size=7))+
  #adding lines for mpa designation years
  geom_vline(aes(xintercept = 2004), pelagicsCINMS_species_block_year, colour="black", size=1)+
  geom_vline(aes(xintercept = 2007), pelagicsCINMS_species_block_year, colour="black", size=1)+
  #adding lines for years where ENSO index was >1.5 
  geom_vline(aes(xintercept = 1991), pelagicsCINMS_species_block_year, colour="black", size=0.75, linetype=3)+ 
  geom_vline(aes(xintercept = 1986), pelagicsCINMS_species_block_year, colour="black", size=0.75, linetype=3)+
  geom_vline(aes(xintercept = 1997), pelagicsCINMS_species_block_year, colour="black", size=0.75, linetype=3)+
  geom_vline(aes(xintercept = 2015), pelagicsCINMS_species_block_year, colour="black", size=0.75, linetype=3)+
  geom_vline(aes(xintercept = 1982), pelagicsCINMS_species_block_year, colour="black", size=0.75, linetype=3)+
  labs(title = str_wrap("CPFV Bonito catch overtime across CINMS fishing blocks", 70))+
   theme(plot.title = element_text(hjust = 0.5))
```
####MACKEREL 
```{r}
Mackerel_CINMS_species_block_year <-subset(pelagicsCINMS_species_block_year, species_type=="Mackerel")
Mackerel_CINMS_species_block_year$year<-as.numeric(Mackerel_CINMS_species_block_year$year)
ggplot(Mackerel_CINMS_species_block_year, aes(year, total, fill=species))+ 
  #geom_point()+
  geom_col()+
  #facet_wrap(~species_group)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust=1))+
  theme(legend.position="top")+
  theme(legend.title=element_blank())+
  xlab("Year")+
  ylab("Total Caught")+
  scale_x_continuous(breaks=seq(1980,2020,1))+
  theme(legend.text=element_text(size=7))+
  #adding lines for mpa designation years
  geom_vline(aes(xintercept = 2004), pelagicsCINMS_species_block_year, colour="black", size=1)+
  geom_vline(aes(xintercept = 2007), pelagicsCINMS_species_block_year, colour="black", size=1)+
  #adding lines for years where ENSO index was >1.5 
  geom_vline(aes(xintercept = 1991), pelagicsCINMS_species_block_year, colour="black", size=0.75, linetype=3)+ 
  geom_vline(aes(xintercept = 1986), pelagicsCINMS_species_block_year, colour="black", size=0.75, linetype=3)+
  geom_vline(aes(xintercept = 1997), pelagicsCINMS_species_block_year, colour="black", size=0.75, linetype=3)+
  geom_vline(aes(xintercept = 2015), pelagicsCINMS_species_block_year, colour="black", size=0.75, linetype=3)+
  geom_vline(aes(xintercept = 1982), pelagicsCINMS_species_block_year, colour="black", size=0.75, linetype=3)+
  labs(title = str_wrap("CPFV Mackerel catch overtime across CINMS fishing blocks", 70))+
   theme(plot.title = element_text(hjust = 0.5))
```

###Heat map
####Blocks in 10 year bins
```{r}
pelagicsCINMS_species_block_year$year<-as.numeric(pelagicsCINMS_species_block_year$year)
pelagicsCINMS_species_block_year$bin_years[pelagicsCINMS_species_block_year$year>=1980 & pelagicsCINMS_species_block_year$year< 1990] <- 1980
pelagicsCINMS_species_block_year$bin_years[pelagicsCINMS_species_block_year$year>=1990 & pelagicsCINMS_species_block_year$year< 2000] <- 1990
pelagicsCINMS_species_block_year$bin_years[pelagicsCINMS_species_block_year$year>=2000 & pelagicsCINMS_species_block_year$year< 2010] <- 2000
pelagicsCINMS_species_block_year$bin_years[pelagicsCINMS_species_block_year$year>=2010 & pelagicsCINMS_species_block_year$year< 2020] <- 2010
pelagicsCINMS_species_block_year$year<-as.character(pelagicsCINMS_species_block_year$year)
```
####Aggregating bins
```{r}
pelagicsCINMS_binnedyrs<-aggregate(pelagicsCINMS_species_block_year$total, by=list(year=pelagicsCINMS_species_block_year$bin_years, block_id= pelagicsCINMS_species_block_year$block_id), FUN=sum)
pelagicsCINMS_binnedyrs<-rename(pelagicsCINMS_binnedyrs, "total"= "x")
pelagicsCINMS_binnedyrs<- replace(pelagicsCINMS_binnedyrs, is.na(pelagicsCINMS_binnedyrs), 0)

```

### Heat map of blocks across years 
```{r}
#joining the shapefile of southern Californian fishing blocks and the total catch by year and block--- NEED TO CHECK TO SEE IF WE HAVE TO REMOVE BLOCKS WITH LESS THAT 3 DATA POINTS


CINMS_fishing_blocks_binned_pelagic <-left_join(SoCal_fishing_blocks, pelagicsCINMS_binnedyrs, by= "block_id", relationship= "many-to-many", na_matches= "never")
CINMS_fishing_blocks_binned_pelagic<- CINMS_fishing_blocks_binned_pelagic %>% drop_na(total)

CINMS_fishing_blocks_binned_pelagic<- subset(CINMS_fishing_blocks_binned_pelagic, !is.na(CINMS_fishing_blocks_binned_pelagic$total))

ggplot() + 
  geom_sf(data = CINMS_fishing_blocks_binned_pelagic, mapping = aes(fill = total))+
  facet_wrap(~year)+
  scale_fill_gradientn(colours=rev(magma(6)),
                         name="Total Pelagic Catch",
                         na.value = "grey100")+
  theme(axis.line=element_blank(),
      axis.text.x=element_blank(),
      axis.text.y=element_blank(),
      axis.ticks=element_blank(),
      axis.title.x=element_blank(),
      axis.title.y=element_blank(),
      panel.background=element_blank(),
      panel.border=element_blank(),
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      plot.background=element_blank())+
  ggtitle("CPFV catch by block in CINMS boundaries")+
   theme(plot.title = element_text(hjust = 0.5))

 
#  geom_sf(data = SoCal_fishing_blocks, mapping = aes(fill = NAME), show.legend = FALSE)
```

#----------
#SoCal Blocks Only
###Year, species, block
####Creating dataframe summed by year
```{r}
pelagicssocal_total<-aggregate(CPFV_pelagics_socal$n_kept, by=list(year=CPFV_pelagics_socal$year), FUN=sum)
pelagicssocal_total<-rename(pelagicssocal_total, "total"= "x")
pelagicssocal_total$year<-as.factor(pelagicssocal_total$year)

```

#### Create dataframe summed by species, year, and block
```{r}
pelagicssocal_species_block_year<-aggregate(CPFV_pelagics_socal$n_kept, by=list(year=CPFV_pelagics_socal$year, block_id=CPFV_pelagics_socal$block_id, species=CPFV_pelagics_socal$species_name, species_type=CPFV_pelagics_socal$species_type), FUN=sum)
pelagicssocal_species_block_year<-rename(pelagicssocal_species_block_year, "total"= "x")
pelagicssocal_species_block_year$year<-as.character(pelagicssocal_species_block_year$year)

```

####**Graphing total trend by species and year
```{r}
pelagicssocal_species_block_year$year<-as.numeric(pelagicssocal_species_block_year$year)
ggplot(pelagicssocal_species_block_year, aes(year, total, fill=species_type))+ 
  #geom_point()+
  geom_col()+
  #facet_wrap(~species_group)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust=1))+
  theme(legend.position="top")+
  theme(legend.title=element_blank())+
  xlab("Year")+
  ylab("Total Caught")+
  scale_x_continuous(breaks=seq(1980,2020,1))+
  theme(legend.text=element_text(size=7))+
  #adding lines for mpa designation years 
  geom_vline(aes(xintercept = 2004), pelagicsmpa_species_block_year, colour="black", size=1)+
  geom_vline(aes(xintercept = 2007), pelagicsmpa_species_block_year, colour="black", size=1)+
  #adding lines for years where ENSO index was >1.5 
  geom_vline(aes(xintercept = 1991), pelagicsmpa_species_block_year, colour="black", size=0.75, linetype=3)+ 
  geom_vline(aes(xintercept = 1986), pelagicsmpa_species_block_year, colour="black", size=0.75, linetype=3)+
  geom_vline(aes(xintercept = 1997), pelagicsmpa_species_block_year, colour="black", size=0.75, linetype=3)+
  geom_vline(aes(xintercept = 2015), pelagicsmpa_species_block_year, colour="black", size=0.75, linetype=3)+
  geom_vline(aes(xintercept = 1982), pelagicsmpa_species_block_year, colour="black", size=0.75, linetype=3)+
   labs(title = str_wrap("CPFV catch overtime across Southern California fishing blocks
", 70))+
   theme(plot.title = element_text(hjust = 0.5))
  
```

####Blocks in 10 year bins
```{r}
pelagicssocal_species_block_year$year<-as.numeric(pelagicssocal_species_block_year$year)
pelagicssocal_species_block_year$bin_years[pelagicssocal_species_block_year$year>=1980 & pelagicssocal_species_block_year$year< 1990] <- 1980
pelagicssocal_species_block_year$bin_years[pelagicssocal_species_block_year$year>=1990 & pelagicssocal_species_block_year$year< 2000] <- 1990
pelagicssocal_species_block_year$bin_years[pelagicssocal_species_block_year$year>=2000 & pelagicssocal_species_block_year$year< 2010] <- 2000
pelagicssocal_species_block_year$bin_years[pelagicssocal_species_block_year$year>=2010 & pelagicssocal_species_block_year$year< 2020] <- 2010
pelagicssocal_species_block_year$year<-as.character(pelagicssocal_species_block_year$year)
```
####Aggregating bins
```{r}
pelagicssocal_binnedyrs<-aggregate(pelagicssocal_species_block_year$total, by=list(year=pelagicssocal_species_block_year$bin_years, block_id= pelagicssocal_species_block_year$block_id), FUN=sum)
pelagicssocal_binnedyrs<-rename(pelagicssocal_binnedyrs, "total"= "x")

```

### Heat map of blocks across years 
```{r}
#joining the shapefile of southern Californian fishing blocks and the total catch by year and block--- NEED TO CHECK TO SEE IF WE HAVE TO REMOVE BLOCKS WITH LESS THAT 3 DATA POINTS
SoCal_fishing_blocks_binned_pelagic <-left_join(SoCal_fishing_blocks, pelagicssocal_binnedyrs, by= "block_id", relationship= "many-to-many")

ggplot() + 
  geom_sf(data = SoCal_fishing_blocks_binned_pelagic, mapping = aes(fill = total))+
  facet_wrap(~year)+
  scale_fill_gradientn(colours=rev(magma(6)),
                         name="Total Pelagic Catch",
                         na.value = "grey100")+
  theme(axis.line=element_blank(),
      axis.text.x=element_blank(),
      axis.text.y=element_blank(),
      axis.ticks=element_blank(),
      axis.title.x=element_blank(),
      axis.title.y=element_blank(),
      panel.background=element_blank(),
      panel.border=element_blank(),
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      plot.background=element_blank())+
  ggtitle("CPFV catch by block in Southern California")+
   theme(plot.title = element_text(hjust = 0.5))

 
#  geom_sf(data = SoCal_fishing_blocks, mapping = aes(fill = NAME), show.legend = FALSE)
```

#QAQC 2015 spike
When you look at the data broken down by only year or block, there is a huge spike in catch in 2015. I want to check to make sure that this is real, because it seems strange compared to other years. Similarly, it is weirdly not showing up when I graph the data by species. 
-- when you break it down to only block 765 and only year 2015, the graph above makes sense and is consistent, why then, is there such a huge peak at 2015 in the graph that is not broken down by species?
-- I think that that it just looked weird when it was first depicted, but it is not wrong  


```{r}
species_block_year_2015<-subset(pelagicsmpa_species_block_year, year=="2015" & block_id=="765")
View(species_block_year_2015)

species_year_2015<-subset(pelagicsmpa_species_block_year, year=="2015")
View(species_year_2015)
sum(species_year_2015$total)
#total is 20382

species_2015_mpa_block<-aggregate(species_year_2015$total, by=list(block_id=species_year_2015$block_id), FUN=sum)
View(species_2015_mpa_block)
species_2015_mpa_aggregate<-aggregate(species_year_2015$total, by=list(species=species_year_2015$species), FUN=sum)
View(species_2015_mpa_aggregate)


pelagicsmpa_total_1981<-subset(pelagicsmpa_total, year=="1981")
sum(pelagicsmpa_total_1981$total)

```



#----------
#Mixed Effects Modeling 
first pass at trying to graple with what mixed effects modeling means-
```{r}

```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
