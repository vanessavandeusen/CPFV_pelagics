---
title: "Formatting_Chla_SST_dataframes"
author: "Van Deusen"
date: "2026-02-17"
output: html_document
---

#Inital setup
## Loading libraries
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readr)
library(tidyverse)
library(FishLife)
library(freeR)
library(dplyr)
library(janitor)
library(ggplot2)
library(lubridate)
library(sf)
library(terra)
#library(tidyterra)
library(raster)
library(colorspace)
library(exactextractr)
path_out="C:/Users/vanessa.van.deusen/Desktop/Van.Deusen_Local/CPFV_local/Data/Predictor_Datasets"
```

##Importing Data
```{r}
SST_monthly_avg_CA_raster <- rast("C:/Users/vanessa.van.deusen/Desktop/Van.Deusen_Local/CPFV_local/Data/Predictor_Datasets/Raw/sst.mon.mean.nc")

Chla_monthly_avg_CA_raster <- rast("C:/Users/vanessa.van.deusen/Desktop/Van.Deusen_Local/CPFV_local/Data/Predictor_Datasets/Raw/Chl_A_V6_Plym_Marine_Lab_Ocean_Colour_97_21.nc")


#Chl_a_monthly_avg_CDFW_blocks<-read.csv("C:/Users/vanessa.van.deusen/Desktop/Van.Deusen_Local/CPFV_local/Data/Predictor_Datasets/Raw/Chl_a_CDFW_block_monthly_avg_mg_per_m3.csv")
# avg mg/m3

SST_monthly_avg_CDFW_blocks<- read.csv("C:/Users/vanessa.van.deusen/Desktop/Van.Deusen_Local/CPFV_local/Data/Predictor_Datasets/Raw/sst_monthly_blocks_small_interp.csv")
# avg degrees C

CDFW_blocks<-st_read("C:/Users/vanessa.van.deusen/Desktop/Van.Deusen_Local/CPFV_local/Data/CDFW_fishing_blocks/Commercial_Fishing_Blocks_-_R7_-_CDFW_[ds3093].shp")
```
#______________
#SST
###Summary attributes
```{r}
SST_monthly_avg_CA_raster
#gives you raster attributes 
#720 rows, 1440 columns, 1036800 cells 
#WGS84 projection 
#zvar= sst; z-value= 1981-09-01
#resolution= 0.25, 0.25  (x, y)-- degrees
```

#####Max and Min Values 
```{r}
SST_monthly_avg_CA_raster <-setMinMax(SST_monthly_avg_CA_raster) #adds max and min to attributes 
SST_monthly_avg_CA_raster
```

##### Plot of temperatures within Raster for QAQC
```{r}
plot(SST_monthly_avg_CA_raster, main="Distribution of SST (C)")
```

## Trimming Raster Spatial Extent 
```{r}
SST_monthly_avg_CA_raster_rotate <-rotate(SST_monthly_avg_CA_raster)
plot(SST_monthly_avg_CA_raster_rotate)
cropbox_CA <- extent(-126, -117, 32, 42)
SST_monthly_avg_CA_raster_cropCA <- crop(SST_monthly_avg_CA_raster_rotate, cropbox_CA)
```

#####Max and Min Values 
```{r}
SST_monthly_avg_CA_raster_cropCA <-setMinMax(SST_monthly_avg_CA_raster_cropCA) #adds max and min to attributes 
SST_monthly_avg_CA_raster_cropCA
```

##### Plot of temperatures within Raster for QAQC
```{r}
plot(SST_monthly_avg_CA_raster_cropCA, main="Distribution of SST (C)")
```


#Overlaying CDFW Blocks
####Ensuring same CRS 
```{r}
crs(SST_monthly_avg_CA_raster_cropCA)
```

```{r}
crs(CDFW_blocks) 
```
###### Transforming CRS
```{r}
CDFW_blocks_updatecrs <- CDFW_blocks%>%
  st_transform(crs(SST_monthly_avg_CA_raster_cropCA)) %>% #changing crs to match SST data
  vect() #turning into a terra spatial vector 

CDFW_blocks_updatecrs
crs(CDFW_blocks_updatecrs) #checking crs to make sure updated 
```

##Plotting overlay 
```{r}
ext(SST_monthly_avg_CA_raster_cropCA)
#SpatExtent : -126, -117, 32, 42 (xmin, xmax, ymin, ymax)
ext(CDFW_blocks_updatecrs)
#SpatExtent : -125.667907632446, -117.097051415794, 32.3333873907098, 41.9998867422286 (xmin, xmax, ymin, ymax)
plot(SST_monthly_avg_CA_raster_cropCA[[1]])
plot(CDFW_blocks_updatecrs, border= "black", add= T)
```

#Zonal Stats-- avg SST/block
##Checking block dataframe as SpatVector
```{r}
CDFW_blocks_updatecrs
#is a SpatVector-- geometry= pologyon, 546 geometries, 6 attributes, long/lat WGS84
```

##Running Zonal Statistics
```{r}
#turning CDFW 
CDFW_blocks_asSF<-st_as_sf(CDFW_blocks_updatecrs)

#putting time as the layer names
names(SST_monthly_avg_CA_raster_cropCA) <- time(SST_monthly_avg_CA_raster_cropCA)

#running zonal statistics
exact_extractSST <- exact_extract(SST_monthly_avg_CA_raster_cropCA, 
                                  CDFW_blocks_asSF, 
                                  'mean', 
                                  append_cols= "BLOCK10_ID")

SST_monthly_avg_by_block_zonal_table <- exact_extractSST %>%
  pivot_longer( #changes formatting so that all in one column 
    cols = starts_with("mean"), 
    names_to = "date", 
    values_to = "avg_temp"
  ) %>%
  mutate(date= gsub("mean.", "", date))
```

####QAQC Zonal
######Graphing
```{r}
plot(SST_monthly_avg_CA_raster_cropCA[[1]])
plot(st_geometry(CDFW_blocks_asSF), add = TRUE, border = "black")
```

######Checking Values manual
```{r}
#pick a test block
test_block_QAQC <- CDFW_blocks_asSF$BLOCK10_ID[102]
single_block <- CDFW_blocks_asSF[CDFW_blocks_asSF$BLOCK10_ID== test_block_QAQC,]

#Isolate raster data for block 
test_QAQC_SST_raster <- crop(SST_monthly_avg_CA_raster_cropCA[[1]], single_block, mask=T)

#Manually calculate weighted mean 
test_QAQC_SST_raster_mean <- terra::global(test_QAQC_SST_raster, 
                                           fun= "mean", 
                                           na.rm= T)$mean
#Compare to exact_extract results 
test_QAQC_SST_raster_exactextract_mean <- SST_monthly_avg_by_block_zonal_table %>%
  filter(BLOCK10_ID== test_block_QAQC) %>%
  slice(1) %>%
  pull(avg_temp)

#Print comparison 
cat("Manual Mean (Terra)", test_QAQC_SST_raster_mean, "\n")
cat("Exact Extract Mean", test_QAQC_SST_raster_exactextract_mean, "\n")
cat("Difference:     ", test_QAQC_SST_raster_mean - test_QAQC_SST_raster_exactextract_mean, "\n")
### Huzzah! They match

```

##### Looking at Temperature Distribution
```{r}
hist(SST_monthly_avg_by_block_zonal_table$avg_temp)
#slightly left skewed bell curve approximation
```


#####Finding NAs
```{r}
#finding NAs 
na_blocks <- SST_monthly_avg_by_block_zonal_table %>%
  filter(is.na(avg_temp))
if(nrow(na_blocks) > 0) {
  print("Warning: The following blocks have NA temperatures:")
  print(unique(na_blocks$BLOCK10_ID))
} else {
  print("QAQC Pass: No NA values found in extraction.")
}
#Nas for 101, 301, 489, 678, 679, 680 
# 101 in land at border-- no coverage
# 301, 489 San Francisco bay-- no coverage
# 678, 679, 680 along Malibu-- no coverage
#488-- very little coverage but still including

```

###Removing NA  Blocks
```{r}
SST_monthly_avg_by_block_final <-SST_monthly_avg_by_block_zonal_table %>%
  filter(!is.na(avg_temp)) %>%
  filter(!is.nan(avg_temp)) %>%
  mutate(
    year= year(date), 
    month= month(date)
  )
```

#Export SST Data
```{r}
write.csv(SST_monthly_avg_by_block_final, file.path(path_out, "SST_monthly_avg_by_block_final.csv"))

```

#_________________
#Chlorophyll- A
PRE-SPATIALLY TRIMMED TO CA WATER BOUNDARIES 
###Summary attributes
```{r}
Chla_monthly_avg_CA_raster
#gives you raster attributes 
#518 rows, 638 columns, 1960178 cells 
#WGS84 projection 
#resolution= 0.04166667, 0.04166667    (x, y)-- degrees
#zvar= chlor_a; z-value= date
##MUCH SMALLER THAN SST RASTER GRID SIZE
```

#####Max and Min Values 
```{r}
Chla_monthly_avg_CA_raster <-setMinMax(Chla_monthly_avg_CA_raster) #adds max and min to attributes 
Chla_monthly_avg_CA_raster
```

##### Graph of temperatures within Raster for QAQC
```{r}

chla_viz<- Chla_monthly_avg_CA_raster[[1]] %>%
  clamp(lower=0, upper=5, values=T)

terra::plot(chla_viz, main="Distribution of Chl-a (mg/m3)")
```

#Overlaying CDFW Blocks
####Ensuring same CRS 
```{r}
crs(Chla_monthly_avg_CA_raster)
```

```{r}
crs(CDFW_blocks) 
```
###### Transforming CRS
```{r}
CDFW_blocks_updatecrs_chla <- CDFW_blocks%>%
  st_transform(crs(Chla_monthly_avg_CA_raster)) %>% #changing crs to match SST data
  vect() #turning into a terra spatial vector 

CDFW_blocks_updatecrs_chla
crs(CDFW_blocks_updatecrs_chla) #checking crs to make sure updated 
```

##Plotting overlay 
```{r}
ext(Chla_monthly_avg_CA_raster)
#SpatExtent : -137.666666666667, -111.083333333333, 25.5833333333333, 47.1666666666667 (xmin, xmax, ymin, ymax)
ext(CDFW_blocks_updatecrs_chla)
#SpatExtent : -125.667907632446, -117.097051415794, 32.3333873907098, 41.9998867422286 (xmin, xmax, ymin, ymax)


terra::plot(chla_viz, main="Distribution of Chl-a (mg/m3)") #same manually clamped values for first layer as before
terra::plot(CDFW_blocks_updatecrs_chla, add= T)

```

#Zonal Stats-- avg SST/block
##Checking block dataframe as SpatVector
```{r}
CDFW_blocks_updatecrs_chla
#is a SpatVector-- geometry= pologyon, 546 geometries, 6 attributes, long/lat WGS84
```

##Running Zonal Statistics
```{r}
#turning CDFW 
CDFW_blocks_updatecrs_chla_asSF<-st_as_sf(CDFW_blocks_updatecrs_chla)

#putting time as the layer names
names(Chla_monthly_avg_CA_raster) <- time(Chla_monthly_avg_CA_raster)

#running zonal statistics
exact_extract_chla <- exact_extract(Chla_monthly_avg_CA_raster, 
                                  CDFW_blocks_updatecrs_chla_asSF, 
                                  'mean', 
                                  append_cols= "BLOCK10_ID")

Chla_monthly_avg_by_block_zonal_table <- exact_extract_chla %>%
  pivot_longer( #changes formatting so that all in one column 
    cols = starts_with("mean"), 
    names_to = "date", 
    values_to = "avg_temp"
  ) %>%
  mutate(date= gsub("mean.", "", date))
```

####QAQC Zonal
######Graphing
```{r}
plot(Chla_monthly_avg_CA_raster[[1]])
plot(st_geometry(CDFW_blocks_updatecrs_chla_asSF), add = TRUE, border = "black")
```

######Checking Values manual
```{r}
#pick a test block
test_block_QAQC_chla <- CDFW_blocks_updatecrs_chla_asSF$BLOCK10_ID[102]
single_block_chla <- CDFW_blocks_updatecrs_chla_asSF[CDFW_blocks_updatecrs_chla_asSF$BLOCK10_ID== test_block_QAQC_chla,]

#Isolate raster data for block 
test_QAQC_SST_raster_chla <- crop(Chla_monthly_avg_CA_raster[[1]], single_block_chla, mask=T)

#Manually calculate weighted mean 
test_QAQC_SST_raster_chla_mean <- terra::global(test_QAQC_SST_raster_chla, 
                                           fun= "mean", 
                                           na.rm= T)$mean
#Compare to exact_extract results 
test_QAQC_SST_raster_exactextract_mean_chla <- Chla_monthly_avg_by_block_zonal_table %>%
  filter(BLOCK10_ID== test_block_QAQC_chla) %>%
  slice(1) %>%
  pull(avg_temp)

#Print comparison 
cat("Manual Mean (Terra)", test_QAQC_SST_raster_chla_mean, "\n")
cat("Exact Extract Mean", test_QAQC_SST_raster_exactextract_mean_chla, "\n")
cat("Difference:     ", test_QAQC_SST_raster_chla_mean - test_QAQC_SST_raster_exactextract_mean_chla, "\n")
### Huzzah! They match

```

##### Looking at Temperature Distribution
```{r}
hist(Chla_monthly_avg_by_block_zonal_table$avg_temp)
#slightly left skewed bell curve approximation
```


#####Finding NAs
```{r}
#finding NAs 
na_blocks_chla <- Chla_monthly_avg_by_block_zonal_table %>%
  filter(is.na(avg_temp))
if(nrow(na_blocks_chla) > 0) {
  print("Warning: The following blocks have NA temperatures:")
  print(unique(na_blocks_chla$BLOCK10_ID))
} else {
  print("QAQC Pass: No NA values found in extraction.")
}
#Nas for 101 102 103 107 108 113 114 115 120 126 132 201 208 209 210 216 222 227 262 268 301 401 430 507 516
#525 528 542 550 551 552 557 558 559 565 566 567 663 677 678 694 695 696 717 732 735 736 753 755 775
# 776 777 838 839 858 859 876

# 101 in land at border-- no coverage
# 301, 489 San Francisco bay-- no coverage
# 678, 679, 680 along Malibu-- no coverage
#488-- very little coverage but still including

```

###Removing NA  Blocks
```{r}
SST_monthly_avg_by_block_final <-SST_monthly_avg_by_block_zonal_table %>%
  filter(!is.na(avg_temp)) %>%
  filter(!is.nan(avg_temp)) %>%
  mutate(
    year= year(date), 
    month= month(date)
  )
```

#Export SST Data
```{r}
write.csv(SST_monthly_avg_by_block_final, file.path(path_out, "SST_monthly_avg_by_block_final.csv"))

```




#_________________

Ensure same CRS system
```{r}
#check CRS system of SST Raster 
terra::crs(SST_monthly_avg_CA_raster)
```



#Formatting Temp and Chl-a
## Checking column coding 
```{r}
#Reformatting block_id for Chl-a
Monthly_mean_chl_a_format<- Chl_a_monthly_avg_CDFW_blocks %>%
  mutate(block_id= as.numeric(as.character(Monthly_mean_chl_a$BLOCK10_ID))) %>%
  select(-BLOCK10_ID)

#Reformatting block_id for temp
Monthly_mean_temp_format<- SST_monthly_avg_CDFW_blocks %>%
  mutate(block_id= as.numeric(as.character(Monthly_mean_temp$BLOCK10_ID))) %>%
  select(-BLOCK10_ID)

##Reformatting CDFW blocks and colnames
CDFW_blocks_format <- CDFW_blocks %>%
  mutate(block_id= as.numeric(as.character(CDFW_blocks$BLOCK10_ID))) %>%
  select(- BLOCK10_ID)

```


#Block Skeleton
```{r}
block_skeleton <- expand_grid(
  block_id = unique(CDFW_blocks_format$block_id), 
  year= 1980:2020, 
  month= 1:12
)
```


##SST
```{r}
SST_monthly_avg_CDFW_blocks_formatted <- Monthly_mean_temp_format %>%
  mutate(StdTime = mdy_hms(StdTime), #converts to POSIXct format
         month= month(StdTime), 
         year= year(StdTime), 
         ) 
```

##Join SST Data to Skeleton to Understand Gaps
```{r}
SST_monthly_avg_CDFW_blocks_complete <- block_skeleton %>%
  left_join(SST_monthly_avg_CDFW_blocks_formatted, by= c("block_id", "month", "year"))

#unique missing blocks 
na_SST_monthly <- SST_monthly_avg_CDFW_blocks_complete %>%
  group_by(block_id, month) %>%
  summarise(
    na_count = sum(is.na(MEAN)),
    .groups = "drop"
  ) %>% 
  #filtering out when NA is 41 
  filter(na_count== 41) %>%
  group_by(block_id) %>%
  summarise(
    missing_month_count = n(),
    .groups = "drop"
  ) %>%
  # Final filter: only keep blocks that have all 12 months missing
  filter(missing_month_count == 12)
  #here, when there are 41 instances of NA across 12 months, it means that that block is never represented in the data 

```


#####Exporting 
```{r}
write.csv(SST_monthly_avg_CDFW_blocks_formatted, file.path(path_out, "SST_monthly_avg_CDFW_blocks_formatted.csv"))
```

##Chl_a
```{r}
Chl_a_monthly_avg_CDFW_blocks_formatted <- Chl_a_monthly_avg_CDFW_blocks %>%
  mutate(StdTime = mdy_hms(StdTime), #converts to POSIXct format
         month= month(StdTime), 
         year= year(StdTime)) 
```

#####Exporting 
```{r}
write.csv(Chl_a_monthly_avg_CDFW_blocks_formatted, file.path(path_out, "Chl_a_monthly_avg_CDFW_blocks_formatted.csv"))
```
